
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Selección de Asientos</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <style>
    :root{
      --bg:#f7f9fc; --card:#ffffff; --text:#1f2937; --muted:#6b7280;
      --primary:#2c7be5; --success:#10b981; --shadow:0 8px 20px rgba(17,24,39,.08);
      --brandA: rgba(44,123,229,.10); --brandB: rgba(16,185,129,.08);
      --logo-w-ideal: 84vw; --logo-w-max: 360px;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --action-bar-h: 72px;
    }
    html,body{height:100%;}
    html{ scroll-padding-bottom: calc(var(--action-bar-h) + var(--safe-bottom)); }
    body{
      margin:0; font-family: system-ui,-apple-system, Segoe UI, Roboto, Ubuntu, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
      color:var(--text); background:var(--bg); overflow-x:hidden;
    }
    *, *::before, *::after{ box-sizing:border-box; }

    /* ===== Header ===== */
    .hero{
      width:100%;
      background: linear-gradient(180deg, var(--brandA) 0%, var(--brandB) 45%, rgba(255,255,255,0) 100%);
      padding:clamp(12px,4vw,24px); display:grid; place-items:center;
      min-height: clamp(110px, 24vw, 210px);
    }
    .brand-chip{
      position:relative;
      display:inline-flex; align-items:center; justify-content:center;
      padding:clamp(8px,2.4vw,16px) clamp(12px,3vw,20px);
      border-radius:16px; background: rgba(255,255,255,.55);
      border:1px solid rgba(255,255,255,.65); box-shadow:0 8px 24px rgba(17,24,39,.12);
      max-width:92vw; overflow: visible;
    }
    .logo-skeleton{
      width: min(var(--logo-w-ideal), var(--logo-w-max));
      height: clamp(64px, 18vw, 140px);
      border-radius:12px;
      background: linear-gradient(90deg, #eef2ff 0%, #f7f9fc 40%, #eef2ff 80%);
      background-size: 200% 100%;
      animation: shimmer 1.2s ease-in-out infinite;
    }
    @keyframes shimmer{ 0%{background-position: 0% 0;} 100%{background-position: 200% 0;} }
    .brand-chip img{
      width: min(var(--logo-w-ideal), var(--logo-w-max));
      max-width:100%; height:auto; display:block; object-fit:contain; margin:0 auto;
      filter: drop-shadow(0 3px 8px rgba(17,24,39,.14));
      opacity:0; transition: opacity .25s ease;
      cursor: pointer;
    }
    .brand-chip img.ready{ opacity:1; }

    /* Contenedor principal */
    .app{padding:clamp(12px,3vw,20px);}
    .view{display:none;}
    .view.active{display:block; animation:fadeIn .4s ease both;}
    @keyframes fadeIn{from{opacity:0; transform:translateY(6px);} to{opacity:1; transform:none;}}

    /* Inicio + cards */
    .home-center{min-height:calc(100dvh - 160px); display:grid; place-items:center;}
    .cards{display:grid; grid-template-columns:1fr; gap:14px; max-width:480px; width:100%;}
    .card{
      background:var(--card); border-radius:14px; box-shadow:var(--shadow);
      padding:18px; display:flex; flex-direction:column; gap:8px;
      cursor:pointer; transition:transform .15s ease, box-shadow .2s ease; text-align:center;
    }
    .card:hover{transform:translateY(-2px); box-shadow:0 10px 24px rgba(17,24,39,.12);}
    .card h2{margin:0; font-size:1.15rem;}
    .card p{margin:0; color:var(--muted);}
    .view-title{
      margin:0 0 16px 0;
      font-size:1rem; line-height:1.25; font-weight:800; letter-spacing:.2px;
      color:var(--text); text-align:center;
    }

    /* Formularios */
    .form{background:var(--card); border-radius:14px; box-shadow:var(--shadow); padding:16px; margin-bottom:12px;}
    .form-row{display:flex; flex-direction:column; gap:6px; margin-bottom:10px;}
    label{font-weight:600;}
    input{border:1px solid #e5e7eb; border-radius:10px; padding:12px; font-size:1rem; background:#fff; color:var(--text);}
    .actions{display:flex; gap:8px; flex-wrap:wrap;}
    .btn{border:none; border-radius:10px; padding:12px 14px; font-weight:600; cursor:pointer; min-height:44px;}
    .btn.primary{background:var(--primary); color:white;}
    .btn.ghost{background:transparent; border:1px solid #e5e7eb; color:var(--text);}
    .btn.success{background:var(--success); color:white;}
    .btn.danger{background:#ef4444; color:white;}

    /* Legend / chips */
    .legend{display:flex; gap:8px; margin:8px 0 12px; flex-wrap:wrap;}
    .badge{display:inline-flex; align-items:center; gap:6px; border-radius:999px; padding:6px 10px; font-size:.875rem;}
    .badge.libre{background:#d1fae5; color:#065f46;}
    .badge.ocupado{background:#fee2e2; color:#7f1d1d;}
    .badge.seleccionado{background:#dbeafe; color:#1e40af;}
    .badge.inexistente{background:#e5e7eb; color:#374151;}

    /* Croquis 2+2 */
    .grid{display:flex; flex-direction:column; gap:8px;}
    .row{ display:grid; grid-template-columns:minmax(0,1fr) 20px minmax(0,1fr); gap:8px; align-items:center; width:100%; }
    .block{display:grid; grid-template-columns:repeat(2, 1fr); gap:8px;}
    .aisle{width:20px; height:20px;}
    .seat{
      border:none; border-radius:12px; padding:12px; font-weight:700; box-shadow:var(--shadow);
      transition:transform .1s ease, box-shadow .2s ease, background .2s ease, color .2s ease;
      width:100%; position:relative; overflow:hidden; min-height:48px;
    }
    .seat.libre{background:#e6fffa; color:#0f766e;}
    .seat.ocupado{background:#fee2e2; color:#7f1d1d; cursor:not-allowed;}
    .seat.seleccionado{background:#dbeafe; color:#1e40af; transform:scale(1.02);}
    .seat.inexistente{background:#f3f4f6; color:#6b7280; cursor:not-allowed; opacity:.9;}
    .seat:active{transform:scale(0.98);}

    /* Resaltado (Mirá tu asiento) */
    .seat.mine{ outline:3px solid #6366f1; box-shadow:0 0 0 3px rgba(99,102,241,.15) inset; }
    .seat.mine::after{ content:""; position:absolute; inset:0; border-radius:12px; box-shadow:0 0 0 0 rgba(99,102,241,.25); animation:pulse 1.8s ease-in-out infinite; }
    @keyframes pulse{ 0%{box-shadow:0 0 0 0 rgba(99,102,241,.25);} 70%{box-shadow:0 0 0 10px rgba(99,102,241,0);} 100%{box-shadow:0 0 0 0 rgba(99,102,241,0);} }
    .nums{display:flex; gap:10px; flex-wrap:wrap;}
    .nums .pill{background:#eef2ff; color:#1e3a8a; border-radius:999px; padding:6px 10px; font-weight:700; display:inline-flex;}

    /* Más espacio debajo del botón “Ver croquis” y encima del croquis */
    #findFeedback .actions, #multiFeedback .actions { margin-top:14px; margin-bottom:18px; }
    #grid-find, #multiCroquis { margin-top:16px; }

    /* Asignación múltiple */
    .assign{ margin-top: 12px; padding-bottom: calc(var(--action-bar-h) + var(--safe-bottom)); }
    .assign-list{ display:flex; flex-direction:column; gap:16px; }
    .assign-row{
      background:var(--card); border-radius:12px; box-shadow:var(--shadow);
      padding:16px; display:grid; gap:10px; scroll-margin-bottom:12px;
    }
    .assign-title{ font-size:1rem; font-weight:800; color:var(--text); }
    .assign-grid{ display:grid; grid-template-columns:1fr; gap:10px; }
    @media (min-width:560px){ .assign-grid{ grid-template-columns:1fr 1fr; } }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .field-label{ font-weight:600; font-size:.9rem; color:var(--muted); }

    /* Bottom App Bar (solo botones) */
    .assign .action-bar{
      position: fixed; left: 0; right: 0; bottom: 0; z-index: 30;
      height: calc(var(--action-bar-h) + var(--safe-bottom));
      display: grid; place-items: center;
      background: transparent; border: none; box-shadow: none; pointer-events: none;
    }
    .assign .action-bar .actions{
      width: min(680px, 92vw); display:flex; gap:10px;
      padding: 0 12px var(--safe-bottom) 12px; pointer-events: auto;
    }
    .assign .action-bar .btn{ flex: 1; min-height: 44px; }

    /* Control interno */
    .control-board{background:var(--card); border-radius:14px; box-shadow:var(--shadow); padding:16px 12px; margin-top:12px;}
    .control-title{margin:0 0 12px 0; font-size:1.1rem; font-weight:700;}
    .control-toolbar{
      position: sticky; top: 8px; z-index: 20; display:flex; flex-direction:column; gap:10px;
      padding:12px; border-radius:14px; background: rgba(255,255,255,.72);
      border:1px solid rgba(255,255,255,.80); box-shadow:0 8px 24px rgba(17,24,39,.10);
      transition: transform .25s ease, box-shadow .25s ease, background .25s ease; margin-bottom: 20px;
    }
    .control-toolbar.scrolled{ transform: translateY(2px); box-shadow:0 12px 28px rgba(17,24,39,.16); background: rgba(255,255,255,.82); }
    .control-actions{display:flex; gap:8px; flex-wrap:wrap;}
    .sel-tags{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .sel-tags .tag{border-radius:999px; padding:6px 10px; font-weight:700; background:#e5e7eb; color:#374151;}
    .sel-tags .tag.src{background:#fef3c7; color:#92400e;}
    .sel-tags .tag.dst{background:#dbeafe; color:#1e40af;}
    .edit-actions{display:none; gap:8px; flex-wrap:wrap;}
    .control-toolbar.editing .edit-actions{display:flex;}

    /* Snackbar & Overlay */
    .snackbar{position:fixed; left:50%; bottom:20px; transform:translateX(-50%); background:#111827; color:#fff; padding:12px 16px; border-radius:12px; box-shadow:var(--shadow); opacity:0; pointer-events:none;}
    .snackbar.show{opacity:1; transition:opacity .2s ease;}
    .overlay{position:fixed; inset:0; background:rgba(17,24,39,.28); display:grid; place-items:center; opacity:0; pointer-events:none; transition:opacity .15s ease;}
    .overlay.show{opacity:1; pointer-events:auto;}
    .loader{background:var(--card); border-radius:14px; box-shadow:var(--shadow); padding:16px 18px; display:flex; align-items:center; gap:12px;}
    .spinner{width:20px; height:20px; border-radius:50%; border:3px solid #c7d2fe; border-top-color:#3b82f6; animation:spin .9s linear infinite;}
    @keyframes spin { to { transform: rotate(360deg); } }
    .loader-text{font-weight:600; color:#111827;}
    @media (prefers-reduced-motion: reduce){ .view.active{animation:none} .spinner{animation:none} }
    .hidden{display:none !important;}

    /* Croquis de Control */
    #controlCroquis .seat{ display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:56px; }
    #controlCroquis .seat .num{ font-size: 1rem; line-height: 1; font-weight: 800; }
    #controlCroquis .seat .occ-name{ margin-top:4px; font-size:.75rem; line-height:1.1; font-weight:600; color:#374151; letter-spacing:.2px; max-width:100%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    #controlCroquis .seat.ocupado .occ-name{ color:#7f1d1d; }

    /* Elegir viaje / elegir planta */
    .trip-list{ display:grid; grid-template-columns:1fr; gap:12px; max-width:560px; margin:0 auto; }
    .trip-card{ background:var(--card); border-radius:14px; box-shadow:var(--shadow); padding:16px; display:flex; flex-direction:column; gap:6px; cursor:pointer; }
    .trip-card h3{ margin:0; font-size:1rem; }
    .trip-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .trip-pill{ display:inline-flex; align-items:center; gap:6px; border-radius:999px; padding:4px 8px; font-size:.8rem; background:#eef2ff; color:#1e3a8a; }
    .floors{ display:grid; grid-template-columns:1fr; gap:12px; max-width:560px; margin:12px auto 0; }
    @media (min-width:520px){ .floors{ grid-template-columns:1fr 1fr; } }
    .floors .card h2{ font-size:1rem; }
    .trip-tags{ display:flex; gap:8px; flex-wrap:wrap; margin:8px 0; }
    .trip-tags .tag{ border-radius:999px; padding:6px 10px; font-weight:700; background:#e5e7eb; color:#374151; }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="hero" aria-label="Cabecera">
    <div class="brand-chip">
      <div id="logoSkeleton" class="logo-skeleton" aria-hidden="true"></div>
      <img id="heroLogo" alt="Logo" />
      <div id="adminMenu" class="admin-menu hidden" role="dialog" aria-modal="false" aria-label="Acceso staff">
        <p class="admin-title">Acceso staff</p>
        <div class="actions" style="display:flex; flex-direction:column; gap:8px;">
          <button type="button" id="btnAdminLogin" class="btn primary btn-admin" onclick="openStaffLogin()">Control interno</button>
          <button type="button" id="btnAdminControl" class="btn ghost btn-admin hidden" onclick="goToControlBoard()">Panel de control</button>
          <button type="button" id="btnAdminLogout" class="btn danger btn-admin hidden" onclick="doControlLogout()">Cerrar sesión staff</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Staff badge -->
  <div id="staffBadge" class="staff-badge hidden" aria-label="Perfil Staff">Staff</div>

  <main id="app" class="app">
    <!-- Elegir viaje -->
    <section id="view-choose" class="view active" aria-label="Elegí el viaje">
      <div class="home-center" style="align-items:start;">
        <div style="max-width:680px; margin:0 auto; width:100%;">
          <h2 class="view-title">Elegí tu viaje</h2>
          <div id="tripList" class="trip-list"></div>
        </div>
      </div>
    </section>

    <!-- Elegir planta (doble piso) -->
    <section id="view-floor" class="view" aria-label="Elegí planta">
      <div class="home-center" style="align-items:start;">
        <div style="max-width:680px; margin:0 auto; width:100%;">
          <h2 class="view-title">Elegí planta</h2>
          <div class="floors" id="floorCards"></div>
          <div class="cards" id="floorFindCard" style="margin-top:16px;"></div>
          <div class="actions" style="margin-top:32px; justify-content:center;">
            <button type="button" class="btn ghost" onclick="backToChoose()">Cambiar viaje</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Menú principal (convencional) -->
    <section id="view-home" class="view" aria-label="Inicio">
      <div class="home-center">
        <div style="max-width:560px; width:100%; margin-bottom:12px;">
          <div class="trip-tags">
            <span class="tag" id="tagTrip">Viaje: —</span>
          </div>
        </div>
        <div class="cards">
          <article class="card" tabindex="0" role="button" onclick="goSelect()" onkeypress="handleEnter(event, goSelect)">
            <h2>Seleccionar asiento</h2>
            <p>Elige tu lugar y confirma con tu nombre y CI.</p>
          </article>
          <article class="card" tabindex="0" role="button" onclick="goFind()" onkeypress="handleEnter(event, goFind)">
            <h2>Mirá tu asiento</h2>
            <p>Ingresa tu CI para ver tus números y el croquis.</p>
          </article>
        </div>
        <div class="actions" style="margin-top:14px;">
          <button class="btn ghost" onclick="backToChoose()">Cambiar viaje</button>
        </div>
      </div>
    </section>

    <!-- Selección (público) -->
    <section id="view-select" class="view" aria-label="Seleccionar asiento">
      <form id="selectForm" class="form" onsubmit="event.preventDefault(); startSelection();">
        <div class="form-row">
          <label for="nombrePrincipal">Nombre del pasajero</label>
          <input id="nombrePrincipal" type="text" placeholder="Nombre y Apellido" required autocomplete="name" autocapitalize="words" enterkeyhint="next" />
        </div>
        <div class="form-row">
          <label for="ciPrincipal">CI del pasajero</label>
          <input id="ciPrincipal" type="text" placeholder="Ej.: 12345678" inputmode="numeric" pattern="[0-9]*" required autocomplete="off" enterkeyhint="done" />
        </div>
        <div class="actions">
          <button type="submit" class="btn primary">Reservar</button>
          <button type="button" class="btn ghost" onclick="refreshSeatsWithSpinner('grid-select')">Actualizar</button>
        </div>
        <p class="hint">Presiona “Actualizar” para ver reservas recientes.</p>
      </form>
      <div id="legend" class="legend">
        <span class="badge libre">Libre</span>
        <span class="badge ocupado">Ocupado</span>
        <span class="badge seleccionado">Seleccionado</span>
        <span class="badge inexistente">Gris: Inhabilitado / No disponible</span>
      </div>
      <div id="grid-select" class="grid" aria-live="polite" aria-busy="true"></div>

      <!-- Asignación múltiple -->
      <section id="view-assign" class="assign hidden" aria-label="Asignar nombres">
        <h3>Asignar nombres a tus asientos</h3>
        <p>Como reservaste más de un asiento, indicanos los nombres y CI de tu dupla o grupo.</p>
        <div id="assignList" class="assign-list"></div>
        <div class="action-bar">
          <div class="actions">
            <button type="button" class="btn ghost" onclick="backToSelect()">Volver</button>
            <button type="button" class="btn success" onclick="confirmReservation()">Confirmar reserva</button>
          </div>
        </div>
      </section>

      <div id="reserveFeedback" class="feedback hidden">
        <h4>Reserva confirmada</h4>
        <div id="reserveNums" class="nums"></div>
        <div class="actions" style="margin-top:8px;">
          <button type="button" class="btn ghost" onclick="goHome()">Inicio</button>
        </div>
      </div>
    </section>

    <!-- Mirá tu asiento (single y multi) -->
    <section id="view-find" class="view" aria-label="Mirá tu asiento">
      <form id="findForm" class="form" onsubmit="event.preventDefault(); findByCI();">
        <div class="form-row">
          <label for="ciSearch">CI del pasajero</label>
          <input id="ciSearch" type="text" placeholder="Ej.: 12345678" inputmode="numeric" pattern="[0-9]*" required autocomplete="off" enterkeyhint="search" />
        </div>
        <div class="actions">
          <button type="submit" class="btn primary">Buscar</button>
          <button type="button" class="btn ghost" onclick="goTripMenu()">Inicio</button>
        </div>
      </form>

      <div id="findFeedback" class="feedback hidden">
        <h4>Asientos para tu CI</h4>
        <div id="findNums" class="nums"></div>
        <div class="actions">
          <button id="btnShowCroquis" type="button" class="btn primary" onclick="showCroquisForCI()">Ver croquis</button>
        </div>
      </div>
      <div id="grid-find" class="grid" aria-live="polite" aria-busy="true"></div>

      <div id="multiFeedback" class="feedback hidden">
        <h4>Asientos por planta</h4>
        <div id="multiNums"></div>
        <div class="actions">
          <button id="btnShowCroquisMulti" type="button" class="btn primary" onclick="showCroquisForCIMulti()">Ver croquis</button>
        </div>
      </div>
      <div id="multiCroquis"></div>
    </section>

    <!-- Control interno -->
    <section id="view-control" class="view" aria-label="Control interno">
      <form id="controlForm" class="form" onsubmit="event.preventDefault(); doControlLogin();">
        <div class="form-row">
          <label for="ctlUser">Usuario</label>
          <input id="ctlUser" type="text" placeholder="Usuario" autocomplete="username" required />
        </div>
        <div class="form-row">
          <label for="ctlPass">Contraseña</label>
          <input id="ctlPass" type="password" placeholder="Contraseña" autocomplete="current-password" required />
        </div>
        <div class="actions">
          <button type="submit" class="btn primary">Ingresar</button>
          <button type="button" class="btn ghost" onclick="goHome()">Inicio</button>
        </div>
        <p class="hint">Acceso exclusivo para el staff.</p>
      </form>

      <div id="controlBoard" class="control-board" hidden>
        <h4 class="control-title">Ocupación por número</h4>
        <div id="controlToolbar" class="control-toolbar">
          <div class="control-actions">
            <button type="button" class="btn ghost" onclick="refreshSeatsWithSpinner(null, renderControlBoard)">Actualizar</button>
            <button type="button" class="btn primary" onclick="doExportPdf()">Exportar PDF</button>
            <button id="btnEditMode" type="button" class="btn success" onclick="toggleControlEdit()">Modo edición</button>
          </div>
          <div class="sel-tags">
            <span class="tag src" id="tagSrc">Origen: —</span>
            <span class="tag dst" id="tagDst">Destino: —</span>
          </div>
          <div class="edit-actions">
            <button id="btnMove" type="button" class="btn primary" onclick="movePassenger()" disabled>Mover</button>
            <button id="btnFree" type="button" class="btn danger" onclick="freeSelectedSeat()" disabled>Liberar</button>
            <button id="btnCancel" type="button" class="btn ghost" onclick="cancelEdit()" disabled>Cancelar</button>
          </div>
        </div>
        <div id="controlCroquis" class="grid" aria-live="polite"></div>
        <div id="pdfLinkFallback" class="hint hidden"></div>
      </div>
    </section>
  </main>

  <!-- Overlay de carga -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="loader">
      <div class="spinner"></div>
      <div class="loader-text">Cargando…</div>
    </div>
  </div>
  <!-- Snackbar -->
  <div id="snackbar" class="snackbar" role="status" aria-live="assertive" aria-atomic="true"></div>

  <!-- ===== api.js ===== -->
  <script>
    const BASE_URL = 'https://script.google.com/macros/s/AKfycbyJYarovqJhUHxRFy_aG4_ex5YUpM4ALC2mQhqsYiMNxjoEo7F3NxvYrC9FuSXFz7sp/exec';
    const API_KEY = null;

    const QS = (params = {}) =>
      '?' + Object.entries(params)
        .filter(([, v]) => v !== undefined && v !== null && v !== '')
        .map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`)
        .join('&');

    async function parseResponse(res) {
      const text = await res.text();
      try { return JSON.parse(text); } catch { return text; }
    }
    function withCommonParams(extra = {}) {
      const base = { api: '1', ...extra };
      if (API_KEY) base.apiKey = API_KEY;
      return base;
    }
    function getUrl(action, extraParams = {}) {
      const params = withCommonParams({ action, ...extraParams });
      return BASE_URL + QS(params);
    }
    function postOptions(payloadObj) {
      return {
        method: 'POST',
        redirect: 'follow',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(payloadObj ?? {})
      };
    }

    async function apiGetTrips(folderId) {
      const res = await fetch(getUrl('trips', { folderId }));
      if (!res.ok) throw new Error(`GET trips: ${res.status}`);
      return parseResponse(res);
    }
    async function apiGetSeats(fileId, sheetName) {
      const res = await fetch(getUrl('seats', { fileId, sheetName }));
      if (!res.ok) throw new Error(`GET seats: ${res.status}`);
      return parseResponse(res);
    }
    async function apiGetSeatsByCi(fileId, sheetName, ci) {
      const res = await fetch(getUrl('seatsByCi', { fileId, sheetName, ci }));
      if (!res.ok) throw new Error(`GET seatsByCi: ${res.status}`);
      return parseResponse(res);
    }
    async function apiGetLogo() {
      const res = await fetch(getUrl('logo'));
      if (!res.ok) throw new Error(`GET logo: ${res.status}`);
      return parseResponse(res);
    }
    async function apiExportPdf(fileId, sheetName) {
      const res = await fetch(getUrl('exportPdf', { fileId, sheetName }));
      if (!res.ok) throw new Error(`GET exportPdf: ${res.status}`);
      return parseResponse(res);
    }
    async function apiReserve(fileId, sheetName, pairs) {
      const res = await fetch(getUrl('reserve'), postOptions({ fileId, sheetName, pairs }));
      if (!res.ok) throw new Error(`POST reserve: ${res.status}`);
      return parseResponse(res);
    }
    async function apiMove(fileId, sheetName, sourceCode, targetCode){
      const res = await fetch(getUrl('move'), postOptions({ fileId, sheetName, sourceCode, targetCode }));
      if (!res.ok) throw new Error(`POST move: ${res.status}`);
      return parseResponse(res);
    }
    async function apiFree(fileId, sheetName, code) {
      const res = await fetch(getUrl('free'), postOptions({ fileId, sheetName, code }));
      if (!res.ok) throw new Error(`POST free: ${res.status}`);
      return parseResponse(res);
    }

    window.API = { apiGetTrips, apiGetSeats, apiGetSeatsByCi, apiGetLogo, apiExportPdf, apiReserve, apiMove, apiFree };
  </script>

  <!-- ===== Lógica de la app ===== -->
  <script>
    /* Estado global */
    let SEATS = {}; let selected = new Set(); let NUM_LABELS = new Map();
    let HIGHLIGHT_CODES = new Set(); let LAST_FOUND_CODES = [];
    let CONTROL_AUTH = false; let CONTROL_EDIT = false; let EDIT_SRC = null; let EDIT_DST = null;
    let BUSY = false; // se usa solo en operaciones críticas (reservar/mover/liberar/pdf)

    /* Offsets por planta + caché por hoja */
    let FLOOR_OFFSETS = new Map();  // sheetName => offset
    let SEATS_CACHE   = new Map();  // sheetName => seatsMap

    /* Viaje/hoja actual */
    let CURRENT_TRIP = { fileId: null, name: null, sheets: [], sheetName: null, hasFloors: false };

    /* Persistencia staff */
    const STAFF_KEY = 'app_staff_mode';
    function setStaffSession(enabled){ try { if (enabled) localStorage.setItem(STAFF_KEY, '1'); else localStorage.removeItem(STAFF_KEY); } catch(e){} }
    function isStaffSession(){ try { return localStorage.getItem(STAFF_KEY) === '1'; } catch(e){ return false; } }

    /* Navegación */
    function showView(id){ document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function goHome(){ if(!CURRENT_TRIP.fileId || !CURRENT_TRIP.sheetName){ showView('view-choose'); return; } updateTripTags(); showView('view-home'); }
    function goTripMenu(){
      if(!CURRENT_TRIP.fileId){ showView('view-choose'); return; }
      if(CURRENT_TRIP.hasFloors){ showView('view-floor'); } else { updateTripTags(); showView('view-home'); }
    }
    function handleEnter(ev, cb){ if(ev.key === 'Enter') cb(); }

    /* UI helpers */
    function toast(msg){ const bar = document.getElementById('snackbar'); bar.textContent = msg; bar.classList.add('show'); setTimeout(() => bar.classList.remove('show'), 2800); }
    function showLoading(msg){ const ov = document.getElementById('overlay'); ov.querySelector('.loader-text').textContent = msg ?? 'Cargando…'; ov.setAttribute('aria-hidden','false'); ov.classList.add('show'); }
    function hideLoading(){ const ov = document.getElementById('overlay'); ov.classList.remove('show'); ov.setAttribute('aria-hidden','true'); }
    function normalize(code){ return (code ?? '').toString().replace(/\u00A0/g,' ').replace(/\s+/g,'').trim().toUpperCase(); }
    function firstName(full){ const t = (full ?? '').trim(); if(!t) return ''; const name = t.split(/\s+/)[0]; return name.charAt(0).toUpperCase() + name.slice(1).toLowerCase(); }
    function onlyDigits(el){ el.value = el.value.replace(/\D+/g, ''); }

    /* Admin (Easter Egg) */
    function showAdminMenu(){ document.getElementById('adminMenu').classList.remove('hidden'); }
    function hideAdminMenu(){ document.getElementById('adminMenu').classList.add('hidden'); }
    function toggleAdminMenu(){ document.getElementById('adminMenu').classList.toggle('hidden'); }
    function updateAdminMenu(){
      const bLogin = document.getElementById('btnAdminLogin');
      const bPanel = document.getElementById('btnAdminControl');
      const bLogout = document.getElementById('btnAdminLogout');
      if(!bLogin || !bPanel || !bLogout) return;
      const isAuth = CONTROL_AUTH;
      bLogin.classList.toggle('hidden', isAuth);
      bPanel.classList.toggle('hidden', !isAuth);
      bLogout.classList.toggle('hidden', !isAuth);
    }
    function syncStaffBadge(){ const el = document.getElementById('staffBadge'); if (!el) return; el.classList.toggle('hidden', !CONTROL_AUTH); }
    function syncControlFormVisibility(){ const form = document.getElementById('controlForm'); if (!form) return; form.hidden = CONTROL_AUTH; }

    /* Elegir viaje */
    async function loadTrips(){
      console.log('[loadTrips] inicio');
      showLoading('Cargando viajes…');
      try{
        const payload = await API.apiGetTrips();
        const list = document.getElementById('tripList'); list.innerHTML = '';
        (payload.trips ?? []).forEach(tr => {
          const card = document.createElement('div'); card.className='trip-card'; card.tabIndex=0;
          const head = document.createElement('div'); head.className='trip-head';
          const title = document.createElement('h3'); title.textContent = tr.name;
          const pill = document.createElement('span'); pill.className='trip-pill'; pill.textContent = tr.hasFloors ? 'Doble piso' : 'Convencional';
          head.appendChild(title); head.appendChild(pill);
          card.appendChild(head);
          card.onclick = () => selectTrip(tr);
          card.onkeypress = (ev) => { if(ev.key==='Enter') selectTrip(tr); };
          list.appendChild(card);
        });
        if(!((payload.trips ?? []).length)){ list.innerHTML = '<p class="muted">No se encontraron viajes en la carpeta.</p>'; }
      }catch(err){ console.error('[loadTrips] error', err); toast('No se pudieron cargar los viajes'); }
      finally{ hideLoading(); console.log('[loadTrips] fin'); }
    }

    function selectTrip(tr){
      console.log('[selectTrip]', tr?.name);
      CURRENT_TRIP = { fileId: tr.fileId, name: tr.name, sheets: tr.sheets, sheetName: null, hasFloors: !!tr.hasFloors };
      FLOOR_OFFSETS = new Map();
      SEATS_CACHE   = new Map();

      if(CURRENT_TRIP.hasFloors){
        const floorBox = document.getElementById('floorCards'); floorBox.innerHTML = '';
        const extraBox = document.getElementById('floorFindCard'); extraBox.innerHTML = '';
        const bajaName = tr.sheets.find(s => s.toLowerCase() === 'asientos baja');
        const altaName = tr.sheets.find(s => s.toLowerCase() === 'asientos alta');
        const candidates = [];
        if(bajaName) candidates.push({ label:'Planta baja', sheetName:bajaName, desc:'Acceso rápido, usualmente cerca del conductor.' });
        if(altaName) candidates.push({ label:'Planta alta', sheetName:altaName, desc:'Mayor altura y vista panorámica.' });
        if(!candidates.length){ tr.sheets.forEach(s => candidates.push({ label:s, sheetName:s, desc:null })); }

        const makeCard = (label, desc, onClick) => {
          const card = document.createElement('article'); card.className='card'; card.tabIndex=0; card.setAttribute('role','button');
          const h2 = document.createElement('h2'); h2.textContent = label;
          const p = document.createElement('p'); p.textContent = desc ?? '';
          card.appendChild(h2); card.appendChild(p);
          card.onclick = onClick;
          card.onkeypress = (ev) => { if(ev.key==='Enter') onClick(); };
          return card;
        };
        candidates.forEach(c => {
          const el = makeCard(c.label, c.desc ? c.desc : `Hoja: ${c.sheetName}`, () => chooseFloor(c.sheetName));
          floorBox.appendChild(el);
        });
        const findCard = makeCard('Mirá tu asiento', 'Buscá tus asientos por CI en ambas plantas.', () => goFind());
        extraBox.appendChild(findCard);
        showView('view-floor');
      }else{
        // Convencional
        const sheet = tr.sheets.find(s => s.toLowerCase() === 'asientos') ?? tr.sheets[0];
        chooseFloor(sheet);
      }
    }

    /* Helpers doble piso */
    function getFloorSheets(){
      const sheets = CURRENT_TRIP.sheets ?? [];
      const baja = sheets.find(s => s.toLowerCase() === 'asientos baja');
      const alta = sheets.find(s => s.toLowerCase() === 'asientos alta');
      const result = [];
      if(baja) result.push({ sheetName:baja, label:'Planta baja' });
      if(alta) result.push({ sheetName:alta, label:'Planta alta' });
      if(!result.length) result.push(...sheets.map(s => ({ sheetName:s, label:s })));
      return result;
    }
    function getAltaBajaNames(){
      const floors = getFloorSheets();
      const alta = floors.find(f => (f.label?.toLowerCase().includes('alta') || f.sheetName?.toLowerCase().includes('alta')))?.sheetName ?? null;
      const baja = floors.find(f => (f.label?.toLowerCase().includes('baja') || f.sheetName?.toLowerCase().includes('baja')))?.sheetName ?? null;
      return { alta, baja };
    }
    function getRowsToRenderFromMap(seatsMap){
      const rows = new Set();
      Object.entries(seatsMap ?? {}).forEach(([code, seat]) => {
        const m = code.match(/^(\d+)[A-Z]$/);
        if(!m) return;
        const row = parseInt(m[1], 10);
        const estado = (seat.estado ?? '').toLowerCase().trim();
        if(estado !== 'inhabilitado') rows.add(row);
      });
      return Array.from(rows).sort((a,b)=>a-b);
    }
    function computeClassForWith(seatsMap, code){
      const key = normalize(code);
      if(!seatsMap.hasOwnProperty(key)) return 'inexistente';
      const st = (seatsMap[key].estado ?? '').toLowerCase().trim();
      if(st === 'ocupado') return 'ocupado';
      if(st === 'inhabilitado') return 'inexistente';
      return 'libre';
    }
    function countNumberedSeatsFromMap(seatsMap){
      const rows = getRowsToRenderFromMap(seatsMap);
      let count = 0;
      for(const row of rows){
        for(const letter of ['A','B','C','D']){
          const code = `${row}${letter}`;
          const klass = computeClassForWith(seatsMap, code);
          if (klass === 'libre' || klass === 'ocupado') count++;
        }
      }
      return count;
    }

    /* Offset “perezoso” (solo si hace falta) */
    async function ensureOffsetForCurrentFloor(){
      if (!CURRENT_TRIP.hasFloors) { FLOOR_OFFSETS.set(CURRENT_TRIP.sheetName, 0); return; }
      const sheet = CURRENT_TRIP.sheetName;
      if (FLOOR_OFFSETS.has(sheet)) return;

      const { alta, baja } = getAltaBajaNames();
      if (!alta || !baja) { FLOOR_OFFSETS.set(sheet, 0); return; }

      if (sheet === alta) { FLOOR_OFFSETS.set(alta, 0); return; }
      if (sheet === baja) {
        let altaMap = SEATS_CACHE.get(alta);
        if (!altaMap) {
          try {
            const resp = await API.apiGetSeats(CURRENT_TRIP.fileId, alta);
            const rows = resp.rows ?? [];
            altaMap = {};
            rows.forEach(r => { altaMap[ normalize(r.asiento) ] = { estado: r.estado, pasajero: r.pasajero ?? '', ci: r.ci ?? '' }; });
            SEATS_CACHE.set(alta, altaMap);
          } catch(e) {
            console.warn('[ensureOffsetForCurrentFloor] no pude cargar planta alta, offset=0');
            FLOOR_OFFSETS.set(baja, 0);
            return;
          }
        }
        const countAlta = countNumberedSeatsFromMap(altaMap);
        FLOOR_OFFSETS.set(alta, 0);
        FLOOR_OFFSETS.set(baja, countAlta);
      }
    }

    /* Elegir planta / navegación principal */
    async function chooseFloor(sheetName){
      console.log('[chooseFloor]', sheetName);
      CURRENT_TRIP.sheetName = sheetName;
      updateTripTags();

      if (CONTROL_AUTH) {
        showView('view-control');
        showLoading('Cargando ocupación…');
        await refreshSeats(null, () => { renderControlBoard(); hideLoading(); });
      } else {
        if (CURRENT_TRIP.hasFloors) {
          showView('view-select');
          showLoading('Cargando asientos…');
          await refreshSeats('grid-select', () => hideLoading());
        } else {
          goHome(); // MENÚ (convencional)
        }
      }
    }
    function backToChoose(){
      CURRENT_TRIP = { fileId:null, name:null, sheets:[], sheetName:null, hasFloors:false };
      FLOOR_OFFSETS = new Map();
      SEATS_CACHE   = new Map();
      showView('view-choose');
    }
    function updateTripTags(){
      const tagTrip = document.getElementById('tagTrip');
      if (tagTrip) tagTrip.textContent = `Viaje: ${CURRENT_TRIP.name ?? '—'}`;
      syncStaffBadge();
    }

    /* ====== Datos (una hoja) ====== */
    async function refreshSeats(targetId, onDone){
      console.log('[refreshSeats] targetId=', targetId, 'sheet=', CURRENT_TRIP.sheetName);
      const gridEl = targetId ? document.getElementById(targetId) : null;
      if(gridEl) gridEl.setAttribute('aria-busy','true');
      try{
        let seatsMap = SEATS_CACHE.get(CURRENT_TRIP.sheetName);
        if (!seatsMap) {
          const resp = await API.apiGetSeats(CURRENT_TRIP.fileId, CURRENT_TRIP.sheetName);
          const rows = resp.rows ?? [];
          seatsMap = {};
          rows.forEach(r => { seatsMap[ normalize(r.asiento) ] = { estado: r.estado, pasajero: r.pasajero ?? '', ci: r.ci ?? '' }; });
          SEATS_CACHE.set(CURRENT_TRIP.sheetName, seatsMap);
        }
        SEATS = seatsMap;

        await ensureOffsetForCurrentFloor();

        if(gridEl){ buildGrid(targetId); }
      }catch(err){
        console.error('[refreshSeats] error', err);
        toast('Error al cargar asientos'); if(gridEl){ buildGrid(targetId); }
      }finally{
        if (typeof onDone === 'function') { try { onDone(); } catch(e){} }
        if(gridEl) gridEl.removeAttribute('aria-busy');
      }
    }
    function refreshSeatsWithSpinner(targetId, onDone){
      showLoading('Actualizando asientos…');
      (async () => {
        try{
          const resp = await API.apiGetSeats(CURRENT_TRIP.fileId, CURRENT_TRIP.sheetName);
          const rows = resp.rows ?? [];
          const map = {};
          rows.forEach(r => { map[ normalize(r.asiento) ] = { estado: r.estado, pasajero: r.pasajero ?? '', ci: r.ci ?? '' }; });
          SEATS_CACHE.set(CURRENT_TRIP.sheetName, map);
          SEATS = map;
          await ensureOffsetForCurrentFloor();
          if(targetId){ buildGrid(targetId); }
        }catch(e){ console.error('[refreshSeatsWithSpinner] error', e); toast('Error al actualizar asientos'); }
        finally{ hideLoading(); if (typeof onDone === 'function') onDone(); }
      })();
    }
    function getRowsToRender(){ return getRowsToRenderFromMap(SEATS); }
    function computeClassFor(code){
      const key = normalize(code);
      const s = SEATS[key];
      if(!s) return 'inexistente';
      const st = (s.estado ?? '').toLowerCase().trim();
      if(st === 'ocupado') return 'ocupado';
      if(st === 'inhabilitado') return 'inexistente';
      return 'libre';
    }
    function getMaxRow(){ let maxRow = 0; Object.keys(SEATS).forEach(code => { const m = code.match(/^(\d+)[A-Z]$/); if(m){ const row = parseInt(m[1],10); if(row > maxRow) maxRow = row; } }); return maxRow ?? 0; }

    /* ====== Croquis (una hoja) ====== */
    function buildGrid(targetId){
      const grid = document.getElementById(targetId ?? 'grid-select'); if(!grid) return;
      grid.innerHTML = ''; grid.removeAttribute('aria-busy'); selected = new Set(); NUM_LABELS = new Map();
      const rows = getRowsToRender();
      if(rows.length === 0){ grid.innerHTML = '<p class="empty">No hay asientos cargados en la hoja.</p>'; return; }
      const OFFSET = FLOOR_OFFSETS.get(CURRENT_TRIP.sheetName) ?? 0;
      let seatNumber = OFFSET + 1;

      for(const row of rows){
        const rowEl = document.createElement('div'); rowEl.className = 'row';
        const left = document.createElement('div'); left.className = 'block';
        const right = document.createElement('div'); right.className = 'block';

        const renderSeat = (letter, container)=>{
          const code = `${row}${letter}`;
          const klass = computeClassFor(code);
          const btn = document.createElement('button'); btn.type='button'; btn.className = `seat ${klass}`;
          const isNum = (klass === 'libre' || klass === 'ocupado');
          const norm = normalize(code);
          if(isNum){
            btn.textContent = seatNumber;
            btn.setAttribute('data-code', code);
            btn.setAttribute('aria-label', `Asiento ${code} (${seatNumber}) ${klass}`);
            NUM_LABELS.set(norm, seatNumber); seatNumber++;
            if(targetId === 'grid-select'){
              if(klass === 'libre'){ btn.onclick = () => toggleSeat(code, btn); }
              else { btn.disabled = true; }
            } else {
              btn.disabled = true;
            }
          }else{
            btn.innerHTML = ' ';
            btn.setAttribute('aria-label', `Asiento ${code} inhabilitado/no disponible`);
            btn.disabled = true;
          }
          if(HIGHLIGHT_CODES.has(norm)){ btn.classList.add('mine'); }
          container.appendChild(btn);
        };

        ['A','B'].forEach(l => renderSeat(l, left));
        const aisle = document.createElement('div'); aisle.className = 'aisle';
        ['C','D'].forEach(l => renderSeat(l, right));
        rowEl.appendChild(left); rowEl.appendChild(aisle); rowEl.appendChild(right);
        grid.appendChild(rowEl);
      }
      if(HIGHLIGHT_CODES.size){
        const first = grid.querySelector('.seat.mine');
        if(first) first.scrollIntoView({behavior:'smooth', block:'center'});
      }
    }

    /* Selección (público) */
    function toggleSeat(code, el){
      const key = normalize(code);
      const isSel = selected.has(key);
      if(isSel){ selected.delete(key); el.classList.remove('seleccionado'); }
      else { selected.add(key); el.classList.add('seleccionado'); }
      updateAssignVisibility();
    }
    function updateAssignVisibility(){ if(selected.size > 1){ document.getElementById('view-assign').classList.remove('hidden'); } else { document.getElementById('view-assign').classList.add('hidden'); } }
    function backToSelect(){ document.getElementById('view-assign').classList.add('hidden'); }

    async function startSelection(){
      if(BUSY) return; BUSY = true;
      if(selected.size === 0){ toast('Elegí al menos un asiento'); BUSY=false; return; }
      const nombre = document.getElementById('nombrePrincipal').value.trim();
      const ci = document.getElementById('ciPrincipal').value.trim();
      if(!nombre || !ci){ toast('Completá nombre y CI'); BUSY=false; return; }

      const pairs = Array.from(selected).map(code => ({ asiento: normalize(code), pasajero: nombre, ci }));
      showLoading('Reservando…');
      try{
        await API.apiReserve(CURRENT_TRIP.fileId, CURRENT_TRIP.sheetName, pairs);
        SEATS_CACHE.delete(CURRENT_TRIP.sheetName); // invalida caché
        showReserveFeedbackDetailed(pairs);
        await refreshSeats('grid-select', () => {});
      }catch(err){
        console.error('[startSelection] error', err);
        toast('No se pudo reservar');
      }finally{
        hideLoading(); BUSY=false; document.getElementById('view-assign').classList.add('hidden');
      }
    }

    async function confirmReservation(){
      if(BUSY) return; BUSY = true;
      const inputs = document.querySelectorAll('#assignList .assign-row');
      const pairs = [];
      for(let i=0;i<inputs.length;i++){
        const row = inputs[i];
        const codeNorm = row.getAttribute('data-code');
        const pasajero = row.querySelector('.assign-name').value.trim();
        const ci = row.querySelector('.assign-ci').value.trim();
        if(!pasajero || !ci){ toast(`Faltan datos en ${codeNorm}`); BUSY=false; return; }
        pairs.push({ asiento: codeNorm, pasajero, ci });
      }
      showLoading('Reservando…');
      try{
        await API.apiReserve(CURRENT_TRIP.fileId, CURRENT_TRIP.sheetName, pairs);
        SEATS_CACHE.delete(CURRENT_TRIP.sheetName);
        showReserveFeedbackDetailed(pairs);
        await refreshSeats('grid-select', () => {});
        document.getElementById('view-assign').classList.add('hidden');
      }catch(err){
        console.error('[confirmReservation] error', err);
        toast('No se pudo reservar');
      }finally{
        hideLoading(); BUSY=false;
      }
    }
    function showReserveFeedbackDetailed(pairs){
      const panel = document.getElementById('reserveFeedback'); const nums = document.getElementById('reserveNums'); nums.innerHTML = '';
      (pairs ?? []).forEach(p => {
        const norm = normalize(p.asiento);
        const num = NUM_LABELS.get(norm);
        const pill = document.createElement('span'); pill.className = 'pill';
        pill.textContent = `${(typeof num !== 'undefined') ? num : norm} — ${p.pasajero} (${p.ci})`;
        nums.appendChild(pill);
      });
      panel.classList.remove('hidden'); panel.scrollIntoView({behavior:'smooth'});
    }

    /* ====== Mirá tu asiento (una hoja o ambas plantas) ====== */
    async function findByCI(){
      console.log('[findByCI] begin hasFloors=', CURRENT_TRIP.hasFloors, 'sheet=', CURRENT_TRIP.sheetName);
      if(CURRENT_TRIP.hasFloors && !CURRENT_TRIP.sheetName){
        await findByCIAcrossFloors();
        return;
      }
      if(!CURRENT_TRIP.fileId || !CURRENT_TRIP.sheetName){ console.warn('[findByCI] sin viaje/hoja'); showView('view-choose'); return; }
      const ci = document.getElementById('ciSearch').value.trim();
      if(!ci){ toast('Ingresá tu CI'); return; }

      showLoading('Buscando…');
      try{
        const respSeats = await API.apiGetSeatsByCi(CURRENT_TRIP.fileId, CURRENT_TRIP.sheetName, ci);
        const rawCodes = (respSeats.seats ?? []).map(s => normalize(s));
        LAST_FOUND_CODES = Array.from(new Set(rawCodes));

        let seatsMap = SEATS_CACHE.get(CURRENT_TRIP.sheetName);
        if (!seatsMap) {
          const respRows = await API.apiGetSeats(CURRENT_TRIP.fileId, CURRENT_TRIP.sheetName);
          const rows = respRows.rows ?? [];
          seatsMap = {};
          rows.forEach(r => { seatsMap[ normalize(r.asiento) ] = { estado: r.estado, pasajero: r.pasajero ?? '', ci: r.ci ?? '' }; });
          SEATS_CACHE.set(CURRENT_TRIP.sheetName, seatsMap);
        }
        SEATS = seatsMap;

        await ensureOffsetForCurrentFloor();

        const nums = computeNumbersForCodes(LAST_FOUND_CODES);
        renderFindFeedback(nums);
        HIGHLIGHT_CODES = new Set(LAST_FOUND_CODES);
      }catch(err){
        console.error('[findByCI] error', err);
        toast('Error al buscar por CI');
      }finally{
        hideLoading();
      }
    }
    function computeNumbersForCodes(codes){
      NUM_LABELS = new Map();
      const rows = getRowsToRender();
      const OFFSET = FLOOR_OFFSETS.get(CURRENT_TRIP.sheetName) ?? 0;
      let seatNumber = OFFSET + 1;
      const isNum = (klass) => (klass === 'libre' || klass === 'ocupado');
      for(const row of rows){
        for(const letter of ['A','B','C','D']){
          const code = `${row}${letter}`;
          const klass = computeClassFor(code);
          const norm = normalize(code);
          if(isNum(klass)){ NUM_LABELS.set(norm, seatNumber); seatNumber++; }
        }
      }
      return codes.map(c => NUM_LABELS.get(c)).filter(n => typeof n !== 'undefined');
    }
    function renderFindFeedback(nums){
      const panel = document.getElementById('findFeedback');
      const list = document.getElementById('findNums');
      const btn = document.getElementById('btnShowCroquis');
      list.innerHTML = '';
      if(nums.length){
        nums.forEach(n => { const pill = document.createElement('span'); pill.className='pill'; pill.textContent = String(n); list.appendChild(pill); });
        panel.classList.remove('hidden'); btn.disabled = false; panel.scrollIntoView({behavior:'smooth'});
      }else{
        panel.classList.remove('hidden'); list.innerHTML = '<span class="pill">Sin asientos</span>'; btn.disabled = true;
      }
    }
    function showCroquisForCI(){
      showLoading('Cargando croquis…');
      refreshSeats('grid-find', () => {
        hideLoading();
        const firstMarked = document.getElementById('grid-find').querySelector('.seat.mine');
        if (firstMarked) firstMarked.scrollIntoView({ behavior:'smooth', block:'center' });
        else document.getElementById('grid-find').scrollIntoView({ behavior:'smooth', block:'start' });
        toast(`Resaltados: ${HIGHLIGHT_CODES.size}`);
      });
    }
    function clearFindView(){
      document.getElementById('findFeedback').classList.add('hidden');
      document.getElementById('findNums').innerHTML = '';
      document.getElementById('grid-find').innerHTML = '';
      HIGHLIGHT_CODES = new Set();
      LAST_FOUND_CODES = [];
    }

    /* ====== BÚSQUEDA EN AMBAS PLANTAS (doble piso) ====== */
    let MULTI_SHEETS = [];
    let SEATS_BY_SHEET = new Map();
    let HIGHLIGHT_BY_SHEET = new Map();
    let NUMS_BY_SHEET = new Map();

    async function findByCIAcrossFloors(){
      console.log('[findByCIAcrossFloors] begin');
      if(!CURRENT_TRIP.fileId){ showView('view-choose'); return; }
      const ci = document.getElementById('ciSearch').value.trim();
      if(!ci){ toast('Ingresá tu CI'); return; }

      showLoading('Buscando en ambas plantas…');
      try{
        MULTI_SHEETS = getFloorSheets();
        SEATS_BY_SHEET = new Map();
        HIGHLIGHT_BY_SHEET = new Map();
        NUMS_BY_SHEET = new Map();

        for(const f of MULTI_SHEETS){
          const [respSeats, respRows] = await Promise.all([
            API.apiGetSeatsByCi(CURRENT_TRIP.fileId, f.sheetName, ci),
            API.apiGetSeats(CURRENT_TRIP.fileId, f.sheetName)
          ]);
          const codesRaw = (respSeats.seats ?? []).map(s => normalize(s));
          const codes = Array.from(new Set(codesRaw));
          const rows = respRows.rows ?? [];
          const seatsMap = {};
          rows.forEach(r => { seatsMap[ normalize(r.asiento) ] = { estado: r.estado, pasajero: r.pasajero ?? '', ci: r.ci ?? '' }; });
          SEATS_BY_SHEET.set(f.sheetName, seatsMap);
          HIGHLIGHT_BY_SHEET.set(f.sheetName, new Set(codes));
          SEATS_CACHE.set(f.sheetName, seatsMap);
        }

        const { alta, baja } = getAltaBajaNames();
        if (alta && baja) {
          const countAlta = countNumberedSeatsFromMap(SEATS_CACHE.get(alta) ?? {});
          FLOOR_OFFSETS.set(alta, 0);
          FLOOR_OFFSETS.set(baja, countAlta);
        } else {
          MULTI_SHEETS.forEach(f => FLOOR_OFFSETS.set(f.sheetName, 0));
        }

        for(const f of MULTI_SHEETS){
          const codes = Array.from(HIGHLIGHT_BY_SHEET.get(f.sheetName) ?? []);
          const nums = computeNumbersForCodesWith(SEATS_BY_SHEET.get(f.sheetName) ?? {}, codes, FLOOR_OFFSETS.get(f.sheetName) ?? 0);
          NUMS_BY_SHEET.set(f.sheetName, nums);
        }
        renderFindFeedbackMulti();
      }catch(err){
        console.error('[findByCIAcrossFloors] error', err);
        toast('Error al buscar en ambas plantas');
      }finally{
        hideLoading();
      }
    }
    function computeNumbersForCodesWith(seatsMap, codes, offset=0){
      const rows = getRowsToRenderFromMap(seatsMap);
      let seatNumber = offset + 1;
      const labels = new Map();
      const isNum = (klass) => (klass === 'libre' || klass === 'ocupado');
      for(const row of rows){
        for(const letter of ['A','B','C','D']){
          const code = `${row}${letter}`;
          const klass = computeClassForWith(seatsMap, code);
          const norm = normalize(code);
          if(isNum(klass)){ labels.set(norm, seatNumber); seatNumber++; }
        }
      }
      return codes.map(c => labels.get(c)).filter(n => typeof n !== 'undefined');
    }
    function renderFindFeedbackMulti(){
      clearFindView();
      const panel = document.getElementById('multiFeedback');
      const wrap = document.getElementById('multiNums');
      const btn = document.getElementById('btnShowCroquisMulti');
      wrap.innerHTML = '';
      let totalResults = 0;
      for(const f of MULTI_SHEETS){
        const nums = NUMS_BY_SHEET.get(f.sheetName) ?? [];
        totalResults += nums.length;
        const section = document.createElement('div');
        section.className = 'form'; section.style.marginBottom = '12px';
        const title = document.createElement('h4'); title.textContent = f.label; title.style.margin = '0 0 8px 0';
        const list = document.createElement('div'); list.className = 'nums';
        if(nums.length){
          nums.forEach(n => { const pill = document.createElement('span'); pill.className='pill'; pill.textContent = String(n); list.appendChild(pill); });
        }else{
          const pill = document.createElement('span'); pill.className='pill'; pill.textContent = 'Sin asientos'; list.appendChild(pill);
        }
        section.appendChild(title); section.appendChild(list); wrap.appendChild(section);
      }
      panel.classList.remove('hidden');
      btn.disabled = (totalResults === 0);
      panel.scrollIntoView({behavior:'smooth'});
    }
    async function showCroquisForCIMulti(){
      showLoading('Cargando croquis…');
      const container = document.getElementById('multiCroquis');
      container.innerHTML = '';
      const floorsWithResults = MULTI_SHEETS.filter(f => (NUMS_BY_SHEET.get(f.sheetName) ?? []).length > 0);
      if (!floorsWithResults.length) { hideLoading(); toast('Tu CI no tiene asientos en ninguna planta de este viaje.'); return; }
      for(const f of floorsWithResults){
        const seatsMap = SEATS_BY_SHEET.get(f.sheetName) ?? {};
        const highlights = HIGHLIGHT_BY_SHEET.get(f.sheetName) ?? new Set();
        const form = document.createElement('div');
        form.className = 'form'; form.style.marginBottom = '12px';
        const title = document.createElement('h4'); title.textContent = f.label; title.style.margin = '0 0 8px 0';
        const gridId = `grid-find-${normalize(f.label).toLowerCase()}`;
        const grid = document.createElement('div'); grid.id = gridId; grid.className = 'grid'; grid.setAttribute('aria-live','polite');
        form.appendChild(title); form.appendChild(grid); container.appendChild(form);
        const offset = FLOOR_OFFSETS.get(f.sheetName) ?? 0;
        buildGridCustom(gridId, seatsMap, highlights, offset);
      }
      hideLoading();
      const firstMarked = container.querySelector('.seat.mine');
      if (firstMarked) firstMarked.scrollIntoView({ behavior:'smooth', block:'center' });
      else container.scrollIntoView({ behavior:'smooth', block:'start' });
    }
    function buildGridCustom(targetId, seatsMap, highlightSet, offsetStart=0){
      const grid = document.getElementById(targetId); if(!grid) return;
      grid.innerHTML = '';
      const rows = getRowsToRenderFromMap(seatsMap);
      if(rows.length === 0){ grid.innerHTML = '<p class="empty">No hay asientos cargados en la hoja.</p>'; return; }
      let seatNumber = offsetStart + 1;
      for(const row of rows){
        const rowEl = document.createElement('div'); rowEl.className = 'row';
        const left = document.createElement('div'); left.className = 'block';
        const right = document.createElement('div'); right.className = 'block';
        const renderSeat = (letter, container)=>{
          const code = `${row}${letter}`;
          const klass = computeClassForWith(seatsMap, code);
          const btn = document.createElement('button'); btn.type='button'; btn.className = `seat ${klass}`;
          const isNum = (klass === 'libre' || klass === 'ocupado');
          const norm = normalize(code);
          if(isNum){
            btn.textContent = seatNumber;
            btn.setAttribute('data-code', code);
            btn.setAttribute('aria-label', `Asiento ${code} (${seatNumber}) ${klass}`);
            seatNumber++;
            btn.disabled = true;
          }else{
            btn.innerHTML = ' ';
            btn.setAttribute('aria-label', `Asiento ${code} inhabilitado/no disponible`);
            btn.disabled = true;
          }
          if(highlightSet.has(norm)){ btn.classList.add('mine'); }
          container.appendChild(btn);
        };
        ['A','B'].forEach(l => renderSeat(l, left));
        const aisle = document.createElement('div'); aisle.className = 'aisle';
        ['C','D'].forEach(l => renderSeat(l, right));
        rowEl.appendChild(left); rowEl.appendChild(aisle); rowEl.appendChild(right);
        grid.appendChild(rowEl);
      }
      const first = grid.querySelector('.seat.mine');
      if(first) first.scrollIntoView({behavior:'smooth', block:'center'});
    }

    /* ====== Control interno ====== */
    function openStaffLogin(){
      hideAdminMenu();
      CONTROL_AUTH = false;
      setStaffSession(false);
      updateAdminMenu();
      syncStaffBadge();
      syncControlFormVisibility();
      hideControlBoard();
      showView('view-control');
      const u = document.getElementById('ctlUser'); const p = document.getElementById('ctlPass');
      if(u) u.value = ''; if(p) p.value = '';
    }
    async function doControlLogin(){
      const u = document.getElementById('ctlUser').value.trim();
      const p = document.getElementById('ctlPass').value.trim();
      showLoading('Verificando…');
      try{
        const resp = await API.apiLogin(u,p);
        if(resp && resp.ok){
          CONTROL_AUTH = true;
          setStaffSession(true);
          updateAdminMenu();
          syncStaffBadge();
          syncControlFormVisibility();
          toast('Acceso staff habilitado');
          showView('view-choose');
          await loadTrips();
          hideControlBoard();
        }else{
          CONTROL_AUTH = false;
          setStaffSession(false);
          updateAdminMenu();
          syncStaffBadge();
          syncControlFormVisibility();
          hideControlBoard();
          toast('Usuario o contraseña inválidos');
        }
      }catch(err){
        CONTROL_AUTH = false;
        setStaffSession(false);
        updateAdminMenu();
        syncStaffBadge();
        syncControlFormVisibility();
        hideControlBoard();
        toast('Error de verificación');
      }finally{
        hideLoading();
      }
    }
    function doControlLogout(){
      CONTROL_AUTH = false;
      setStaffSession(false);
      updateAdminMenu();
      syncStaffBadge();
      syncControlFormVisibility();
      hideControlBoard();
      toast('Sesión finalizada');
      backToChoose();
    }
    function renderControlBoard(){
      if(!CONTROL_AUTH){ hideControlBoard(); return; }
      const board = document.getElementById('controlBoard');
      const croquis= document.getElementById('controlCroquis');
      const fb = document.getElementById('pdfLinkFallback');
      board.hidden = false; croquis.innerHTML = '';
      fb.classList.add('hidden'); fb.innerHTML = '';
      CONTROL_EDIT=false; EDIT_SRC=null; EDIT_DST=null; updateEditTags(); syncToolbarUI();
      const maxRow = getMaxRow(); if(maxRow === 0){ croquis.innerHTML = '<p class="empty">No hay asientos cargados en la hoja.</p>'; return; }
      const OFFSET = FLOOR_OFFSETS.get(CURRENT_TRIP.sheetName) ?? 0;
      NUM_LABELS = new Map(); let seatNumber = OFFSET + 1;
      for(let row=1; row<=maxRow; row++){
        const rowEl=document.createElement('div'); rowEl.className='row';
        const left=document.createElement('div'); left.className='block';
        const right=document.createElement('div'); right.className='block';
        const renderSeat=(letter, container)=>{
          const code = `${row}${letter}`;
          const norm = normalize(code);
          const klass= computeClassFor(code);
          const isNum= (klass==='libre' || klass==='ocupado');
          const btn=document.createElement('button'); btn.type='button'; btn.className=`seat ${klass}`;
          if(isNum){
            const occFull = SEATS[norm]?.pasajero ?? '';
            const occName = (klass==='ocupado') ? firstName(occFull) : '';
            btn.innerHTML = `<span class="num">${seatNumber}</span>` + (occName ? `<span class="occ-name">${occName}</span>` : '');
            btn.setAttribute('data-code',code); btn.setAttribute('data-status',klass); btn.setAttribute('data-num',seatNumber);
            btn.setAttribute('aria-label',`Asiento ${code} (${seatNumber}) ${klass}` + (occName ? ` — Ocupa: ${occName}` : ''));
            NUM_LABELS.set(norm,seatNumber); seatNumber++;
          }else{
            btn.innerHTML=' ';
            btn.setAttribute('data-code',code); btn.setAttribute('data-status','inexistente');
            btn.setAttribute('aria-label',`Asiento ${code} inhabilitado/no disponible`);
            btn.disabled=true;
          }
          btn.onclick=()=> onControlSeatClick(btn);
          container.appendChild(btn);
        };
        ['A','B'].forEach(l=>renderSeat(l,left));
        const aisle=document.createElement('div'); aisle.className='aisle';
        ['C','D'].forEach(l=>renderSeat(l,right));
        rowEl.appendChild(left); rowEl.appendChild(aisle); rowEl.appendChild(right);
        croquis.appendChild(rowEl);
      }
      board.scrollIntoView({behavior:'smooth'});
      attachStickyAnimation();
    }
    function attachStickyAnimation(){
      const toolbar = document.getElementById('controlToolbar');
      function onScroll(){ const y=window.scrollY; if(y>24){ toolbar.classList.add('scrolled'); } else { toolbar.classList.remove('scrolled'); } }
      window.removeEventListener('scroll', onScroll);
      window.addEventListener('scroll', onScroll, { passive:true });
      onScroll();
    }
    function hideControlBoard(){
      const board = document.getElementById('controlBoard');
      board.hidden = true;
      document.getElementById('controlCroquis').innerHTML='';
      const fb=document.getElementById('pdfLinkFallback');
      fb.classList.add('hidden'); fb.innerHTML='';
      CONTROL_EDIT=false; EDIT_SRC=null; EDIT_DST=null; updateEditTags(); syncToolbarUI();
    }
    function toggleControlEdit(){ CONTROL_EDIT=!CONTROL_EDIT; updateEditTags(); syncToolbarUI(); toast(CONTROL_EDIT ? 'Modo edición activo' : 'Modo edición desactivado'); }
    function onControlSeatClick(btn){
      if(!CONTROL_EDIT) return;
      const status=(btn.getAttribute('data-status') ?? 'libre').toLowerCase().trim();
      const num =parseInt(btn.getAttribute('data-num') ?? '0',10);
      const code =btn.getAttribute('data-code');
      if(status==='ocupado'){
        document.querySelectorAll('#controlCroquis .seat.pick-source').forEach(el=>el.classList.remove('pick-source'));
        btn.classList.add('pick-source'); EDIT_SRC={num,code};
      }else if(status==='libre'){
        document.querySelectorAll('#controlCroquis .seat.pick-target').forEach(el=>el.classList.remove('pick-target'));
        btn.classList.add('pick-target'); EDIT_DST={num,code};
      }else{ return; }
      updateEditTags(); syncToolbarUI();
    }
    function updateEditTags(){
      const tagSrc=document.getElementById('tagSrc'), tagDst=document.getElementById('tagDst');
      tagSrc.textContent=`Origen: ${EDIT_SRC ? `${EDIT_SRC.num} • ${EDIT_SRC.code}` : '—'}`;
      tagDst.textContent=`Destino: ${EDIT_DST ? `${EDIT_DST.num} • ${EDIT_DST.code}` : '—'}`;
    }
    function syncToolbarUI(){
      const btnEdit=document.getElementById('btnEditMode');
      const btnMove=document.getElementById('btnMove');
      const btnFree=document.getElementById('btnFree');
      const btnCancel=document.getElementById('btnCancel');
      const toolbar=document.getElementById('controlToolbar');
      toolbar.classList.toggle('editing', CONTROL_EDIT);
      if(CONTROL_EDIT){
        btnEdit.classList.add('danger'); btnEdit.textContent='Salir de edición';
        btnMove.disabled=!(EDIT_SRC && EDIT_DST);
        btnFree.disabled=!EDIT_SRC;
        btnCancel.disabled=false;
      }else{
        btnEdit.classList.remove('danger'); btnEdit.textContent='Modo edición';
        btnMove.disabled=true; btnFree.disabled=true; btnCancel.disabled=true;
      }
    }
    function cancelEdit(silent=false){
      EDIT_SRC=null; EDIT_DST=null;
      document.querySelectorAll('#controlCroquis .seat.pick-source').forEach(el=>el.classList.remove('pick-source'));
      document.querySelectorAll('#controlCroquis .seat.pick-target').forEach(el=>el.classList.remove('pick-target'));
      updateEditTags(); syncToolbarUI();
      if(!silent) toast('Edición cancelada.');
    }
    async function movePassenger(){
      if (BUSY) return; BUSY = true;
      showLoading('Moviendo pasajero…');
      if(!EDIT_SRC || !EDIT_DST){ hideLoading(); BUSY=false; toast('Selecciona origen (ocupado) y destino (libre).'); return; }
      try{
        const resp=await API.apiMove(CURRENT_TRIP.fileId, CURRENT_TRIP.sheetName, EDIT_SRC.code, EDIT_DST.code);
        toast(resp && resp.message ? resp.message : 'Movimiento realizado');
        SEATS_CACHE.delete(CURRENT_TRIP.sheetName);
        cancelEdit(true);
        await refreshSeats(null, renderControlBoard);
      }catch(err){
        console.error('[movePassenger] error', err);
        toast('No se pudo mover al pasajero');
      }finally{
        hideLoading(); BUSY=false;
      }
    }
    async function freeSelectedSeat(){
      if (BUSY) return; BUSY = true;
      showLoading('Liberando asiento…');
      if(!EDIT_SRC){ hideLoading(); BUSY=false; toast('Selecciona primero un asiento ocupado (origen) para liberar.'); return; }
      try{
        const resp=await API.apiFree(CURRENT_TRIP.fileId, CURRENT_TRIP.sheetName, EDIT_SRC.code);
        toast(resp && resp.message ? resp.message : 'Asiento liberado');
        SEATS_CACHE.delete(CURRENT_TRIP.sheetName);
        cancelEdit(true);
        await refreshSeats(null, renderControlBoard);
      }catch(err){
        console.error('[freeSelectedSeat] error', err);
        toast('No se pudo liberar el asiento');
      }finally{
        hideLoading(); BUSY=false;
      }
    }
    async function doExportPdf(){
      if(!CONTROL_AUTH){ toast('Debes iniciar sesión'); return; }
      if (BUSY) return; BUSY = true;
      showLoading('Generando PDF…');
      try{
        const resp = await API.apiExportPdf(CURRENT_TRIP.fileId, CURRENT_TRIP.sheetName);
        if(resp && resp.url){
          const newWin=window.open(resp.url,'_blank');
          if(!newWin){
            const fb=document.getElementById('pdfLinkFallback');
            fb.innerHTML='Tu PDF está listo: <a href="'+resp.url+'" target="_blank" rel="noopener">Abrir PDF</a>';
            fb.classList.remove('hidden');
          }else{
            toast('PDF listo');
          }
        }else{
          toast(resp && resp.message ? resp.message : 'No se pudo generar el PDF');
        }
      }catch(err){
        console.error('[doExportPdf] error', err);
        toast('Error al generar PDF');
      }finally{
        hideLoading(); BUSY=false;
      }
    }

    /* ===== Inicio ===== */
    (async function init(){
      console.log('[init] start');
      const chip = document.querySelector('.brand-chip');
      chip.childNodes.forEach(n => { if (n.nodeType === Node.TEXT_NODE) n.remove(); });
      const img = document.getElementById('heroLogo');
      const skel = document.getElementById('logoSkeleton');
      img.addEventListener('click', (ev) => { ev.stopPropagation(); toggleAdminMenu(); });
      document.addEventListener('click', (ev) => {
        const menu = document.getElementById('adminMenu');
        if (!chip.contains(ev.target)) { menu.classList.add('hidden'); }
      }, { passive:true });
      let pressTimer = null;
      img.addEventListener('touchstart', () => { pressTimer = setTimeout(() => toggleAdminMenu(), 450); }, {passive:true});
      img.addEventListener('touchend', () => { clearTimeout(pressTimer); }, {passive:true});
      try{
        const payload = await API.apiGetLogo();
        let src = '';
        if (payload && payload.dataUrl) src = payload.dataUrl;
        else if (payload && payload.publicUrl) src = payload.publicUrl;
        if (src) {
          img.onload = () => { img.classList.add('ready'); skel.style.display='none'; };
          img.src = src;
        } else {
          skel.style.display='block';
        }
      }catch(e){
        console.warn('[init] logo error', e);
        skel.style.display='block';
      }
      document.getElementById('ciPrincipal')?.addEventListener('input', e => onlyDigits(e.target));
      document.getElementById('ciSearch')?.addEventListener('input', e => onlyDigits(e.target));
      if (isStaffSession()) {
        CONTROL_AUTH = true;
        updateAdminMenu(); syncStaffBadge(); syncControlFormVisibility();
        await loadTrips();
        showView('view-choose');
      } else {
        updateAdminMenu(); syncStaffBadge(); syncControlFormVisibility();
        await loadTrips();
      }
      console.log('[init] done');
    })();
  </script>
</body>
</html>
