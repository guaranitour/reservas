// lib/auth.js
import { GOOGLE_CLIENT_ID } from './constants.js';
export function renderGoogleButton(){ const box = document.getElementById('googleSignIn'); if (!box) return; box.innerHTML=''; box.style.position='relative'; box.style.zIndex='1'; if (!(window.google && google.accounts && google.accounts.id)) return; google.accounts.id.initialize({ client_id: GOOGLE_CLIENT_ID, callback: handleCredentialResponse, cancel_on_tap_outside: true }); google.accounts.id.renderButton(box, { theme:'outline', size:'large', shape:'pill', text:'signin_with', logo_alignment:'left' }); }
export async function handleCredentialResponse(resp){ try{ const token = resp && resp.credential; if (!token){ window.toast?.('No se recibió token'); return; } window.showLoading?.('Verificando…'); const out = await window.API.apiLoginWithToken(token); if (out && out.ok){ window.dispatchEvent(new CustomEvent('auth:login',{ detail:{ ok:true, idToken:token, role: out.role || 'viewer', email: out.email || '' } })); } else { window.dispatchEvent(new CustomEvent('auth:login',{ detail:{ ok:false, message:(out && out.message) || 'No autorizado' } })); } }catch(e){ window.dispatchEvent(new CustomEvent('auth:login',{ detail:{ ok:false, message:'Error de verificación' } })); } finally { window.hideLoading?.(); } }
export function openStaffLogin(){ window.dispatchEvent(new CustomEvent('auth:reset')); const v=document.getElementById('view-control'); if (v){ const all=document.querySelectorAll('.view'); all.forEach(el=>el.classList.remove('active')); v.classList.add('active'); } location.hash = '#/Staff'; const tryRender=()=>{ if (window.google && google.accounts && google.accounts.id) renderGoogleButton(); else setTimeout(tryRender,400); }; tryRender(); }
export function doControlLogout(){ window.dispatchEvent(new CustomEvent('auth:logout')); }