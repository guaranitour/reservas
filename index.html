
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Selección de Asientos</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <!-- Google Identity Services (GIS) -->
  https://accounts.google.com/gsi/client?hl=es-419</script>
  <style>
    :root{
      --bg:#f7f9fc; --card:#ffffff; --text:#1f2937; --muted:#6b7280;
      --primary:#2c7be5; --success:#10b981; --shadow:0 8px 20px rgba(17,24,39,.08);
      --brandA: rgba(44,123,229,.10); --brandB: rgba(16,185,129,.08);
      --logo-w-ideal: 84vw; --logo-w-max: 360px;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
      --action-bar-h: 72px;
      --staff-bg:#fef3c7; --staff-border:#fde68a; --staff-text:#92400e;
    }
    html,body{height:100%;}
    body{
      margin:0; font-family: system-ui,-apple-system, Segoe UI, Roboto, Ubuntu, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
      color:var(--text); background:var(--bg); overflow-x:hidden;
    }
    *, *::before, *::after{ box-sizing:border-box; }
    .hero{ width:100%; background: linear-gradient(180deg, var(--brandA) 0%, var(--brandB) 45%, rgba(255,255,255,0) 100%);
           padding:clamp(12px,4vw,24px); display:grid; place-items:center; min-height: clamp(110px, 24vw, 210px); }
    .brand-chip{ position:relative; display:inline-flex; align-items:center; justify-content:center;
                 padding:clamp(8px,2.4vw,16px) clamp(12px,3vw,20px); border-radius:16px; background: rgba(255,255,255,.55);
                 border:1px solid rgba(255,255,255,.65); box-shadow:0 8px 24px rgba(17,24,39,.12); max-width:92vw; overflow: visible; }
    .logo-skeleton{ width: min(var(--logo-w-ideal), var(--logo-w-max)); height: clamp(64px, 18vw, 140px); border-radius:12px;
                    background: linear-gradient(90deg, #eef2ff 0%, #f7f9fc 40%, #eef2ff 80%); background-size: 200% 100%; animation: shimmer 1.2s ease-in-out infinite; }
    @keyframes shimmer{ 0%{background-position: 0% 0;} 100%{background-position: 200% 0;} }
    .brand-chip img{ width: min(var(--logo-w-ideal), var(--logo-w-max)); max-width:100%; height:auto; display:block; object-fit:contain; margin:0 auto;
                     filter: drop-shadow(0 3px 8px rgba(17,24,39,.14)); opacity:0; transition: opacity .25s ease; cursor: pointer; }
    .brand-chip img.ready{ opacity:1; }
    .admin-menu{
      position: absolute; top: calc(100% + 10px); left: 50%; transform: translateX(-50%);
      width: min(92vw, 360px); padding: 12px; border-radius: 14px; background: rgba(255,255,255,.95);
      border: 1px solid rgba(17,24,39,.08); box-shadow: 0 12px 28px rgba(17,24,39,.16); backdrop-filter: saturate(120%) blur(6px); z-index: 40;
    }
    .admin-menu.hidden{ display:none; }
    .admin-title{ margin:0 0 8px 0; font-weight:800; font-size:.95rem; color:var(--text); text-align:center; }
    .btn-admin{ width:100%; }
    .app{padding:clamp(12px,3vw,20px);}
    .view{display:none;} .view.active{display:block; animation:fadeIn .4s ease both;}
    @keyframes fadeIn{from{opacity:0; transform:translateY(6px);} to{opacity:1; transform:none;}}
    .home-center{min-height:calc(100dvh - 160px); display:grid; place-items:center;}
    .cards{display:grid; grid-template-columns:1fr; gap:14px; max-width:480px; width:100%;}
    .card{background:var(--card); border-radius:14px; box-shadow:var(--shadow); padding:18px; display:flex; flex-direction:column; gap:8px;
          cursor:pointer; transition:transform .15s ease, box-shadow .2s ease; text-align:center;}
    .card:hover{transform:translateY(-2px); box-shadow:0 10px 24px rgba(17,24,39,.12);}
    .view-title{ margin:0 0 16px 0; font-size:1rem; line-height:1.25; font-weight:800; letter-spacing:.2px; color:var(--text); text-align:center; }
    .form{background:var(--card); border-radius:14px; box-shadow:var(--shadow); padding:16px; margin-bottom:12px;}
    .legend{display:flex; gap:8px; margin:8px 0 12px; flex-wrap:wrap;}
    .badge{display:inline-flex; align-items:center; gap:6px; border-radius:999px; padding:6px 10px; font-size:.875rem;}
    .badge.libre{background:#d1fae5; color:#065f46;} .badge.ocupado{background:#fee2e2; color:#7f1d1d;} .badge.seleccionado{background:#dbeafe; color:#1e40af;}
    .badge.inexistente,.badge.inhabilitado{background:#e5e7eb; color:#374151;}
    .grid{display:flex; flex-direction:column; gap:8px;}
    .row{ display:grid; grid-template-columns:minmax(0,1fr) 20px minmax(0,1fr); gap:8px; align-items:center; width:100%; }
    .block{display:grid; grid-template-columns:repeat(2, 1fr); gap:8px;}
    .aisle{width:20px; height:20px;}
    .seat{ border:none; border-radius:12px; padding:12px; font-weight:700; box-shadow:var(--shadow); min-height:48px; width:100%; transition:.2s; }
    .seat.libre{background:#e6fffa; color:#0f766e;}
    .seat.ocupado{background:#fee2e2; color:#7f1d1d; cursor:not-allowed;}
    .seat.seleccionado{background:#dbeafe; color:#1e40af; transform:scale(1.02);}
    .seat.inhabilitado,.seat.inexistente{background:#f3f4f6; color:#6b7280; cursor:not-allowed; opacity:.9;}
    .seat.mine{ outline:3px solid #6366f1; box-shadow:0 0 0 3px rgba(99,102,241,.15) inset; }
    .nums{display:flex; gap:10px; flex-wrap:wrap;}
    .nums .pill{background:#eef2ff; color:#1e3a8a; border-radius:999px; padding:6px 10px; font-weight:700; display:inline-flex;}
    .staff-badge{ position: fixed; top: 12px; right: 12px; z-index: 50; display: inline-flex; gap: 6px; padding: 6px 12px; border-radius: 999px;
                  font-weight: 800; font-size: .85rem; background: #fef3c7; color: #92400e; border: 1px solid #fde68a; box-shadow: 0 8px 20px rgba(17,24,39,.08);}
    .staff-badge.hidden{ display:none; }
    .snackbar{position:fixed; left:50%; bottom:20px; transform:translateX(-50%); background:#111827; color:#fff; padding:12px 16px; border-radius:12px; box-shadow:0 8px 20px rgba(17,24,39,.08); opacity:0;}
    .snackbar.show{opacity:1; transition:opacity .2s ease;}
    .overlay{position:fixed; inset:0; background:rgba(17,24,39,.28); display:grid; place-items:center; opacity:0; pointer-events:none; transition:opacity .15s ease;}
    .overlay.show{opacity:1; pointer-events:auto;}
    .loader{background:#fff; border-radius:14px; box-shadow:0 8px 20px rgba(17,24,39,.08); padding:16px 18px; display:flex; align-items:center; gap:12px;}
    .spinner{width:20px; height:20px; border-radius:50%; border:3px solid #c7d2fe; border-top-color:#3b82f6; animation:spin .9s linear infinite;}
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden{display:none !important;}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="hero" aria-label="Cabecera">
    <div class="brand-chip">
      <div id="logoSkeleton" class="logo-skeleton" aria-hidden="true"></div>
      <img id="heroLogo" alt="Logo" />
      <!-- Menú admin -->
      <div id="adminMenu" class="admin-menu hidden" role="dialog" aria-modal="false" aria-label="Acceso staff">
        <p class="admin-title">Acceso staff</p>
        <div class="actions" style="display:flex; flex-direction:column; gap:8px;">
          <button type="button" id="btnAdminLogin" class="btn btn-admin" style="background:#2c7be5;color:#fff;" onclick="openStaffLogin()">Control interno</button>
          <button type="button" id="btnAdminControl" class="btn btn-admin hidden" onclick="backToChoose(); hideAdminMenu();">Inicio</button>
          <button type="button" id="btnAdminLogout" class="btn btn-admin hidden" style="background:#ef4444;color:#fff;" onclick="doControlLogout()">Cerrar sesión staff</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Staff badge -->
  <div id="staffBadge" class="staff-badge hidden" aria-label="Perfil Staff">Staff</div>

  <main id="app" class="app">
    <!-- Elegir viaje -->
    <section id="view-choose" class="view active" aria-label="Elegí tu viaje">
      <div class="home-center" style="align-items:start;">
        <div style="max-width:680px; margin:0 auto; width:100%;">
          <h2 class="view-title">Elegí tu viaje</h2>
          <div id="tripList" class="trip-list"></div>
        </div>
      </div>
    </section>

    <!-- Elegir planta (doble piso) -->
    <section id="view-floor" class="view" aria-label="Elegí planta">
      <div class="home-center" style="align-items:start;">
        <div style="max-width:680px; margin:0 auto; width:100%;">
          <h2 class="view-title">Elegí planta</h2>
          <div class="trip-tags"><span class="tag" id="tagTripFloor">Viaje: —</span></div>
          <div class="floors" id="floorCards"></div>
          <div class="cards" id="floorFindCard" style="margin-top:16px;"></div>
          <div class="actions" style="margin-top:32px; justify-content:center;">
            <button type="button" class="btn" onclick="backToChoose()">Cambiar viaje</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Menú principal (convencional) -->
    <section id="view-home" class="view" aria-label="Inicio">
      <div class="home-center">
        <div style="max-width:560px; width:100%; margin-bottom:12px;">
          <div class="trip-tags"><span class="tag" id="tagTrip">Viaje: —</span></div>
        </div>
        <div class="cards">
          <article class="card" tabindex="0" role="button" onclick="goSelect()" onkeypress="handleEnter(event, goSelect)">
            <h2>Seleccionar asiento</h2>
            <p>Elige tu lugar y confirma con tu nombre y CI.</p>
          </article>
          <article class="card" tabindex="0" role="button" onclick="goFind()" onkeypress="handleEnter(event, goFind)">
            <h2>Mirá tu asiento</h2>
            <p>Ingresa tu CI para ver tus números y el croquis.</p>
          </article>
        </div>
        <div class="actions" style="margin-top:14px;">
          <button class="btn" onclick="backToChoose()">Cambiar viaje</button>
        </div>
      </div>
    </section>

    <!-- Selección (público) -->
    <section id="view-select" class="view" aria-label="Seleccionar asiento">
      <form id="selectForm" class="form" onsubmit="event.preventDefault(); startSelection();">
        <div class="form-row">
          <label for="nombrePrincipal">Nombre del pasajero</label>
          <input id="nombrePrincipal" type="text" placeholder="Nombre y Apellido" required autocomplete="name" autocapitalize="words" enterkeyhint="next" />
        </div>
        <div class="form-row">
          <label for="ciPrincipal">CI del pasajero</label>
          <input id="ciPrincipal" type="text" placeholder="Ej.: 12345678" inputmode="numeric" pattern="[0-9]*" required autocomplete="off" enterkeyhint="done" />
        </div>
        <div class="actions">
          <button type="submit" class="btn" style="background:#2c7be5;color:#fff;">Reservar</button>
          <button type="button" class="btn" onclick="refreshSelectGrid()">Actualizar</button>
        </div>
        <p class="hint">Presiona “Actualizar” para ver reservas recientes.</p>
      </form>

      <div id="legend" class="legend">
        <span class="badge libre">Libre</span>
        <span class="badge ocupado">Ocupado</span>
        <span class="badge seleccionado">Seleccionado</span>
        <span class="badge inhabilitado">Gris: Inhabilitado en esta planta</span>
      </div>

      <div id="grid-select" class="grid" aria-live="polite" aria-busy="true"></div>

      <!-- Asignación múltiple -->
      <section id="view-assign" class="assign hidden" aria-label="Asignar nombres">
        <h3>Asignar nombres a tus asientos</h3>
        <p>Como reservaste más de un asiento, indicanos los nombres y CI de tu dupla o grupo.</p>
        <div id="assignList" class="assign-list"></div>
        <div class="action-bar">
          <div class="actions">
            <button type="button" class="btn" onclick="backToSelect()">Volver</button>
            <button type="button" class="btn" style="background:#10b981;color:#fff;" onclick="confirmReservation()">Confirmar reserva</button>
          </div>
        </div>
      </section>

      <div id="reserveFeedback" class="feedback hidden">
        <h4>Reserva confirmada</h4>
        <div id="reserveNums" class="nums"></div>
        <div class="actions" style="margin-top:8px;">
          <button type="button" class="btn" onclick="goTripMenu()">Inicio</button>
        </div>
      </div>
    </section>

    <!-- Mirá tu asiento -->
    <section id="view-find" class="view" aria-label="Mirá tu asiento">
      <form id="findForm" class="form" onsubmit="event.preventDefault(); findByCI();">
        <div class="form-row">
          <label for="ciSearch">CI del pasajero</label>
          <input id="ciSearch" type="text" placeholder="Ej.: 12345678" inputmode="numeric" pattern="[0-9]*" required autocomplete="off" enterkeyhint="search" />
        </div>
        <div class="actions">
          <button type="submit" class="btn" style="background:#2c7be5;color:#fff;">Buscar</button>
          <button type="button" class="btn" onclick="goTripMenu()">Inicio</button>
        </div>
      </form>

      <div id="findFeedback" class="feedback hidden">
        <h4>Asientos para tu CI</h4>
        <div id="findNums" class="nums"></div>
        <div class="actions">
          <button id="btnShowCroquis" type="button" class="btn" style="background:#2c7be5;color:#fff;" onclick="showCroquisForCI()">Ver croquis</button>
        </div>
      </div>

      <div id="grid-find" class="grid" aria-live="polite" aria-busy="true"></div>

      <div id="multiFeedback" class="feedback hidden">
        <h4>Asientos por planta</h4>
        <div id="multiNums"></div>
        <div class="actions">
          <button id="btnShowCroquisMulti" type="button" class="btn" style="background:#2c7be5;color:#fff;" onclick="showCroquisForCIMulti()">Ver croquis</button>
        </div>
      </div>

      <div id="multiCroquis"></div>
    </section>

    <!-- Control interno (SOLO botón GIS, sin formulario) -->
    <section id="view-control" class="view" aria-label="Control interno">
      <div class="form" style="margin-bottom:12px;">
        <h4 style="margin:0 0 8px 0;">Acceso con Google</h4>

        <!-- g_id_onload: configura client_id y callback -->
        <div id="g_id_onload"
             data-client_id="273442733710-1eqf1erm1vl9vsad2lb4krennldt1jhf.apps.googleusercontent.com"
             data-callback="handleCredentialResponse"
             data-auto_prompt="false">
        </div>

        <!-- Botón estándar Sign in with Google -->
        <div class="g_id_signin"
             data-type="standard"
             data-size="large"
             data-theme="outline"
             data-text="sign_in_with"
             data-shape="rectangular"
             data-logo_alignment="left">
        </div>

        <p class="hint" style="margin-top:8px;">Acceso exclusivo para el staff.</p>
      </div>

      <div id="controlBoard" class="control-board" hidden>
        <h4 class="control-title">Ocupación por número</h4>

        <div id="controlToolbar" class="control-toolbar">
          <div class="control-actions">
            <button type="button" class="btn" onclick="refreshControlBoardSmart()">Actualizar</button>
            <button id="btnExportPdf" type="button" class="btn" style="background:#2c7be5;color:#fff;" onclick="doExportPdfSmart()">Exportar PDF</button>
            <button id="btnEditMode" type="button" class="btn" style="background:#10b981;color:#fff;" onclick="toggleControlEdit()">Modo edición</button>
          </div>
          <div class="sel-tags">
            <span class="tag src" id="tagSrc">Origen: —</span>
            <span class="tag dst" id="tagDst">Destino: —</span>
          </div>
          <div class="edit-actions">
            <button id="btnMove" type="button" class="btn" style="background:#2c7be5;color:#fff;" onclick="movePassenger()" disabled>Mover</button>
            <button id="btnFree" type="button" class="btn" style="background:#ef4444;color:#fff;" onclick="freeSelectedSeat()" disabled>Liberar</button>
            <button id="btnCancel" type="button" class="btn" onclick="cancelEdit()" disabled>Cancelar</button>
          </div>
        </div>

        <!-- Croquis single -->
        <div id="controlCroquis" class="grid" aria-live="polite"></div>
        <!-- Croquis multi -->
        <div id="controlCroquisMulti"></div>

        <div id="pdfLinkFallback" class="hint hidden"></div>
      </div>
    </section>
  </main>

  <!-- Overlay de carga -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="loader">
      <div class="spinner"></div>
      <div class="loader-text">Cargando…</div>
    </div>
  </div>

  <!-- Snackbar -->
  <div id="snackbar" class="snackbar" role="status" aria-live="assertive" aria-atomic="true"></div>

  <!-- ===== api.js ===== -->
  <script>
    const BASE_URL = 'https://script.google.com/macros/s/AKfycbzusQ64cVeI8snKFqCMjEXf5nivqU3-AMg9Cg3VfHotOFDV36tg2H7T6je02MOunpSX/exec';
    const API_KEY = null;

    function QS(params){
      var q = [];
      for (var k in params){
        if(!params.hasOwnProperty(k)) continue;
        var v = params[k];
        if(v !== undefined && v !== null && v !== '') q.push(encodeURIComponent(k)+'='+encodeURIComponent(v));
      }
      return '?' + q.join('&');
    }
    async function parseResponse(res) {
      const text = await res.text();
      try { return JSON.parse(text); } catch { return text; }
    }
    function withCommonParams(extra) {
      var base = { api: '1' };
      extra = extra || {};
      for (var k in extra){ if(extra.hasOwnProperty(k)) base[k] = extra[k]; }
      if (API_KEY) base.apiKey = API_KEY;
      return base;
    }
    function getUrl(action, extraParams) {
      return BASE_URL + QS(withCommonParams(Object.assign({ action: action }, (extraParams || {}))));
    }
    function postOptions(payloadObj) {
      return { method: 'POST', redirect: 'follow', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payloadObj || {}) };
    }

    // ===== ENDPOINTS PÚBLICOS =====
    async function apiGetTrips(folderId) {
      const res = await fetch(getUrl('trips', { folderId }));
      if (!res.ok) throw new Error('GET trips: ' + res.status);
      return parseResponse(res);
    }
    async function apiGetSeats(fileId, sheetName) {
      const res = await fetch(getUrl('seats', { fileId, sheetName }));
      if (!res.ok) throw new Error('GET seats: ' + res.status);
      return parseResponse(res);
    }
    async function apiGetSeatsByCi(fileId, sheetName, ci) {
      const res = await fetch(getUrl('seatsByCi', { fileId, sheetName, ci }));
      if (!res.ok) throw new Error('GET seatsByCi: ' + res.status);
      return parseResponse(res);
    }
    async function apiGetLogo() {
      const res = await fetch(getUrl('logo'));
      if (!res.ok) throw new Error('GET logo: ' + res.status);
      return parseResponse(res);
    }

    // ===== ENDPOINTS STAFF =====
    async function apiExportPdf(fileId, sheetName) {
      const extra = { fileId, sheetName };
      if (window.STAFF_ID_TOKEN) extra.idToken = window.STAFF_ID_TOKEN;
      const res = await fetch(getUrl('exportPdf', extra));
      if (!res.ok) throw new Error('GET exportPdf: ' + res.status);
      return parseResponse(res);
    }
    async function apiMove(fileId, sheetName, sourceCode, targetCode){
      const res = await fetch(getUrl('move'), postOptions(withIdToken({ fileId, sheetName, sourceCode, targetCode })));
      if (!res.ok) throw new Error('POST move: ' + res.status);
      return parseResponse(res);
    }
    async function apiFree(fileId, sheetName, code) {
      const res = await fetch(getUrl('free'), postOptions(withIdToken({ fileId, sheetName, code })));
      if (!res.ok) throw new Error('POST free: ' + res.status);
      return parseResponse(res);
    }
    async function apiLoginWithToken(idToken) {
      const res = await fetch(getUrl('login'), postOptions({ idToken }));
      if (!res.ok) throw new Error('POST login: ' + res.status);
      return parseResponse(res);
    }

    // ===== Reservar (PÚBLICO) =====
    async function apiReserve(fileId, sheetName, pairs) {
      const res = await fetch(getUrl('reserve'), postOptions({ fileId, sheetName, pairs }));
      if (!res.ok) throw new Error('POST reserve: ' + res.status);
      return parseResponse(res);
    }

    window.API = { apiGetTrips, apiGetSeats, apiGetSeatsByCi, apiGetLogo, apiExportPdf, apiMove, apiFree, apiLoginWithToken, apiReserve };
  </script>

  <!-- ===== Lógica de la app + Router ===== -->
  <script>
    /* ===== Estado global ===== */
    var SEATS = {}; var selected = new Set(); var NUM_LABELS = new Map();
    var HIGHLIGHT_CODES = new Set(); var LAST_FOUND_CODES = [];
    var CONTROL_AUTH = false; var CONTROL_EDIT = false; var EDIT_SRC = null; var EDIT_DST = null;
    var BUSY = false;

    /* Viaje/hoja actual */
    var CURRENT_TRIP = { fileId: null, name: null, sheets: [], sheetName: null, hasFloors: false };

    /* Persistencia staff */
    var STAFF_KEY = 'app_staff_mode';
    function setStaffSession(enabled){ try { if (enabled) localStorage.setItem(STAFF_KEY, '1'); else localStorage.removeItem(STAFF_KEY); } catch(e){} }
    function isStaffSession(){ try { return localStorage.getItem(STAFF_KEY) === '1'; } catch(e){ return false; } }

    /* Staff (multi) */
    var STAFF_CONTROL_MULTI = false;
    var STAFF_ACTIVE_SHEET = null;
    var STAFF_SHEETS = [];
    var STAFF_SEATS_BY_SHEET = new Map();

    /* Router por hash */
    var TRIPS_CACHE = [];
    var ROUTER_DRIVING = false;
    function buildHash(segments){ return '#/' + (segments || []).map(function(s){ return encodeURIComponent(String(s || '')); }).join('/'); }
    function setHash(segments){ if (ROUTER_DRIVING) return; location.hash = buildHash(segments); }
    function getHashSegments(h){
      var raw = String(h || location.hash || '').replace(/^#\/?/, '');
      if (!raw) return [];
      return raw.split('/').map(function(p){ try { return decodeURIComponent(p); } catch(e){ return p; } });
    }

    async function ensureTripsCache(){
      if (TRIPS_CACHE && TRIPS_CACHE.length) return TRIPS_CACHE;
      try{ var payload = await API.apiGetTrips(); TRIPS_CACHE = payload.trips || []; }
      catch(e){ TRIPS_CACHE = []; }
      return TRIPS_CACHE;
    }
    async function resolveTripByName(name){
      var trips = await ensureTripsCache();
      var target = (name || '').trim().toLowerCase();
      return trips.find(function(t){ return (t.name || '').trim().toLowerCase() === target; }) || null;
    }

    function getFloorLabelFromSheetName(sheetName){
      var s = String(sheetName || '').toLowerCase();
      if (s.indexOf('alta') >= 0) return 'Planta alta';
      if (s.indexOf('baja') >= 0) return 'Planta baja';
      return sheetName;
    }
    function getSheetNameFromFloorLabel(trip, floorLabel){
      if (!trip || !Array.isArray(trip.sheets)) return null;
      var lbl = String(floorLabel || '').toLowerCase();
      if (lbl.indexOf('alta') >= 0){
        return trip.sheets.find(function(s){ return s.toLowerCase() === 'asientos alta'; })
            || trip.sheets.find(function(s){ return s.toLowerCase().indexOf('alta') >= 0; })
            || null;
      }
      if (lbl.indexOf('baja') >= 0){
        return trip.sheets.find(function(s){ return s.toLowerCase() === 'asientos baja'; })
            || trip.sheets.find(function(s){ return s.toLowerCase().indexOf('baja') >= 0; })
            || null;
      }
      return trip.sheets.find(function(s){ return s.toLowerCase() === 'asientos'; }) || trip.sheets[0] || null;
    }

    async function routeTo(hash){
      var segs = getHashSegments(hash);
      if (!segs.length){
        setHash(['Inicio']); showView('view-choose'); await loadTrips(); return;
      }
      var head = (segs[0] || '').trim();
      ROUTER_DRIVING = true;
      try{
        if (head.toLowerCase() === 'inicio'){
          showView('view-choose'); await loadTrips(); return;
        }
        if (head.toLowerCase() === 'staff'){
          openStaffLogin(); return;
        }
        if (head.toLowerCase() === 'selección de asientos'){
          var tripNameSel = segs[1];
          var trSel = await resolveTripByName(tripNameSel);
          if (!trSel){ toast('No se encontró el viaje "'+tripNameSel+'".'); backToChoose(); return; }
          CURRENT_TRIP = { fileId: trSel.fileId, name: trSel.name, sheets: trSel.sheets, sheetName: null, hasFloors: !!trSel.hasFloors };
          updateTripTags();
          if (segs[2]){
            var floorLbl = segs[2];
            var sheet = getSheetNameFromFloorLabel(trSel, floorLbl);
            if (!sheet){ toast('No se encontró la planta en "'+trSel.name+'".'); selectTrip(trSel); return; }
            await chooseFloor(sheet); return;
          }
          if (trSel.hasFloors){ selectTrip(trSel); }
          else { var sheetConv = getSheetNameFromFloorLabel(trSel, 'asientos'); CURRENT_TRIP.sheetName = sheetConv; await goSelect(); }
          return;
        }
        var trPlain = await resolveTripByName(head);
        if (!trPlain){ backToChoose(); await loadTrips(); return; }
        selectTrip(trPlain);
      }finally{ ROUTER_DRIVING = false; }
    }

    /* ===== Vistas ===== */
    function showView(id){ var els=document.querySelectorAll('.view'); for(var i=0;i<els.length;i++){ els[i].classList.remove('active'); } document.getElementById(id).classList.add('active'); }
    function goHome(){
      if(!CURRENT_TRIP.fileId || !CURRENT_TRIP.sheetName){ setHash(['Inicio']); showView('view-choose'); return; }
      updateTripTags(); showView('view-home'); setHash([CURRENT_TRIP.name]);
    }
    function goTripMenu(){
      if(!CURRENT_TRIP.fileId){ setHash(['Inicio']); showView('view-choose'); return; }
      if(CURRENT_TRIP.hasFloors){ updateTripTags(); showView('view-floor'); setHash([CURRENT_TRIP.name]); }
      else { updateTripTags(); showView('view-home'); setHash([CURRENT_TRIP.name]); }
    }
    function handleEnter(ev, cb){ if(ev.key === 'Enter') cb(); }

    /* ===== UI helpers ===== */
    function toast(msg){ var bar = document.getElementById('snackbar'); bar.textContent = msg; bar.classList.add('show'); setTimeout(function(){ bar.classList.remove('show'); }, 2800); }
    function showLoading(msg){ var ov = document.getElementById('overlay'); ov.querySelector('.loader-text').textContent = msg || 'Cargando…'; ov.classList.add('show'); }
    function hideLoading(){ var ov = document.getElementById('overlay'); ov.classList.remove('show'); }
    function normalize(code){ return (code || '').toString().replace(/\u00A0/g,' ').replace(/\s+/g,'').trim().toUpperCase(); }
    function firstName(full){ var t = (full || '').trim(); if(!t) return ''; var name = t.split(/\s+/)[0]; return name.charAt(0).toUpperCase() + name.slice(1).toLowerCase(); }
    function onlyDigits(el){ el.value = el.value.replace(/\D+/g, ''); }

    /* ===== Admin menu ===== */
    function showAdminMenu(){ document.getElementById('adminMenu').classList.remove('hidden'); }
    function hideAdminMenu(){ document.getElementById('adminMenu').classList.add('hidden'); }
    function toggleAdminMenu(){ document.getElementById('adminMenu').classList.toggle('hidden'); }
    function updateAdminMenu(){
      var bLogin = document.getElementById('btnAdminLogin');
      var bPanel = document.getElementById('btnAdminControl');
      var bLogout = document.getElementById('btnAdminLogout');
      if(!bLogin || !bPanel || !bLogout) return;
      var isAuth = CONTROL_AUTH;
      bLogin.classList.toggle('hidden', isAuth);
      bPanel.classList.toggle('hidden', !isAuth);
      bLogout.classList.toggle('hidden', !isAuth);
    }
    function syncStaffBadge(){ var el = document.getElementById('staffBadge'); if (!el) return; el.classList.toggle('hidden', !CONTROL_AUTH); }

    /* ===== Elegir viaje ===== */
    async function loadTrips(){
      showLoading('Cargando viajes…');
      try{
        var payload = await API.apiGetTrips();
        var trips = payload.trips || [];
        TRIPS_CACHE = trips;
        var list = document.getElementById('tripList'); list.innerHTML = '';
        trips.forEach(function(tr){
          var card = document.createElement('div'); card.className='card'; card.tabIndex=0; card.setAttribute('role','button');
          var h2 = document.createElement('h3'); h2.textContent = tr.name;
          var pill = document.createElement('p'); pill.textContent = tr.hasFloors ? 'Doble piso' : 'Convencional';
          card.appendChild(h2); card.appendChild(pill);
          card.onclick = function(){ selectTrip(tr); };
          card.onkeypress = function(ev){ if(ev.key==='Enter') selectTrip(tr); };
          list.appendChild(card);
        });
        if(!trips.length){ list.innerHTML = '<p class="muted">No se encontraron viajes en la carpeta.</p>'; }
      }catch(err){ toast('No se pudieron cargar los viajes'); }
      finally{ hideLoading(); }
    }
    function backToChoose(){
      CURRENT_TRIP = { fileId:null, name:null, sheets:[], sheetName:null, hasFloors:false };
      STAFF_CONTROL_MULTI = false; STAFF_ACTIVE_SHEET = null;
      showView('view-choose'); setHash(['Inicio']);
    }
    function selectTrip(tr){
      CURRENT_TRIP = { fileId: tr.fileId, name: tr.name, sheets: tr.sheets, sheetName: null, hasFloors: !!tr.hasFloors };

      // STAFF: panel control
      if (CONTROL_AUTH && CURRENT_TRIP.hasFloors) {
        showView('view-control'); showLoading('Cargando ocupación (ambas plantas)…');
        setHash(['Staff', CURRENT_TRIP.name]); refreshStaffMulti().then(function(){ hideLoading(); });
        return;
      }
      if (CONTROL_AUTH && !CURRENT_TRIP.hasFloors) {
        showView('view-control'); showLoading('Cargando ocupación…');
        setHash(['Staff', CURRENT_TRIP.name]);
        var sheetStaff = tr.sheets.find(function(s){ return s.toLowerCase() === 'asientos'; }) || tr.sheets[0];
        CURRENT_TRIP.sheetName = sheetStaff;
        refreshSeats(null, function(){ renderControlBoard(); hideLoading(); });
        return;
      }

      // Público
      if(CURRENT_TRIP.hasFloors){
        var floorBox = document.getElementById('floorCards'); floorBox.innerHTML = '';
        var extraBox = document.getElementById('floorFindCard'); extraBox.innerHTML = '';
        var bajaName = tr.sheets.find(function(s){ return s.toLowerCase() === 'asientos baja'; });
        var altaName = tr.sheets.find(function(s){ return s.toLowerCase() === 'asientos alta'; });
        var candidates = [];
        if(bajaName) candidates.push({ label:'Planta baja', sheetName:bajaName });
        if(altaName) candidates.push({ label:'Planta alta', sheetName:altaName });
        if(!candidates.length){ tr.sheets.forEach(function(s){ candidates.push({ label:s, sheetName:s }); }); }
        function makeCard(label, onClick){
          var card = document.createElement('article'); card.className='card'; card.tabIndex=0; card.setAttribute('role','button');
          var h2 = document.createElement('h2'); h2.textContent = label;
          card.appendChild(h2); card.onclick = onClick; card.onkeypress = function(ev){ if(ev.key==='Enter') onClick(); };
          return card;
        }
        candidates.forEach(function(c){
          var el = makeCard(c.label, function(){ chooseFloor(c.sheetName); });
          floorBox.appendChild(el);
        });
        var findCard = makeCard('Mirá tu asiento', function(){ goFind(); });
        extraBox.appendChild(findCard);
        updateTripTags(); showView('view-floor'); setHash([CURRENT_TRIP.name]);
      }else{
        var sheet = tr.sheets.find(function(s){ return s.toLowerCase() === 'asientos'; }) || tr.sheets[0];
        CURRENT_TRIP.sheetName = sheet;
        updateTripTags(); showView('view-home'); setHash([CURRENT_TRIP.name]);
      }
    }

    function getFloorSheets(){
      var sheets = CURRENT_TRIP.sheets || [];
      var baja = sheets.find(function(s){ return s.toLowerCase() === 'asientos baja'; });
      var alta = sheets.find(function(s){ return s.toLowerCase() === 'asientos alta'; });
      var result = [];
      if(baja) result.push({ sheetName:baja, label:'Planta baja' });
      if(alta) result.push({ sheetName:alta, label:'Planta alta' });
      if(!result.length) sheets.forEach(function(s){ result.push({ sheetName:s, label:s }); });
      return result;
    }

    /* Tooltip ocupados (staff) */
    function ensureSeatTooltip(){
      var t = document.getElementById('seatTooltip');
      if(!t){ t = document.createElement('div'); t.id = 'seatTooltip'; t.className = 'seat-tooltip'; document.body.appendChild(t); }
      return t;
    }
    function showSeatTooltipFor(btn){
      var status = (btn.getAttribute('data-status') || '').toLowerCase().trim();
      if (status !== 'ocupado') return;
      var full = ''; var occSpan = btn.querySelector('.occ-full'); if (occSpan) full = (occSpan.textContent || '').trim();
      if (!full) return;
      var num = btn.getAttribute('data-num') || ''; var code = btn.getAttribute('data-code') || '';
      var rect = btn.getBoundingClientRect(); var x = rect.left + rect.width/2; var y = rect.top;
      var tip = ensureSeatTooltip();
      tip.innerHTML = '<div>'+full+'</div>' + '<div class="meta">Asiento '+code+(num?(' • N° '+num):'')+'</div>';
      tip.style.left = Math.round(x) + 'px'; tip.style.top = Math.round(y) + 'px';
      tip.classList.add('show'); btn.classList.add('expanded'); btn.setAttribute('aria-expanded','true');
    }
    function hideSeatTooltip(){ var tip = document.getElementById('seatTooltip'); if (tip) tip.classList.remove('show'); collapseExpandedSeats(); }
    function collapseExpandedSeats(){
      var exps = document.querySelectorAll('#controlCroquis .seat.expanded, #controlCroquisMulti .seat.expanded');
      for(var i=0;i<exps.length;i++){ exps[i].classList.remove('expanded'); exps[i].setAttribute('aria-expanded','false'); }
    }
    function toggleSeatExpand(btn){
      if (CONTROL_EDIT) return;
      var status = (btn.getAttribute('data-status') || '').toLowerCase().trim();
      if (status !== 'ocupado') return;
      var isExpanded = btn.classList.contains('expanded');
      hideSeatTooltip();
      if (!isExpanded){ showSeatTooltipFor(btn); }
    }
    function wireStaffExpandAutoCollapse(){
      window.addEventListener('scroll', hideSeatTooltip, { passive:true });
      window.addEventListener('touchmove', hideSeatTooltip, { passive:true });
      window.addEventListener('resize', hideSeatTooltip, { passive:true });
      document.addEventListener('click', function(ev){
        var seat = ev.target.closest('.seat');
        var insideControl = ev.target.closest('#controlCroquis, #controlCroquisMulti');
        if (!insideControl || !seat) hideSeatTooltip();
      }, { passive:true });
    }

    /* STAFF multi (ambas plantas) */
    async function refreshStaffMulti(){
      STAFF_CONTROL_MULTI = true; STAFF_ACTIVE_SHEET = null;
      STAFF_SHEETS = getFloorSheets(); STAFF_SEATS_BY_SHEET = new Map();
      var container = document.getElementById('controlCroquisMulti'); var single = document.getElementById('controlCroquis');
      container.innerHTML = ''; single.innerHTML = '';
      for (var i=0;i<STAFF_SHEETS.length;i++){
        var f = STAFF_SHEETS[i];
        var resp = await API.apiGetSeats(CURRENT_TRIP.fileId, f.sheetName);
        var rows = resp.rows || []; var seatsMap = {};
        rows.forEach(function(r){ seatsMap[ normalize(r.asiento) ] = { estado: r.estado, pasajero: r.pasajero || '', ci: r.ci || '' }; });
        STAFF_SEATS_BY_SHEET.set(f.sheetName, seatsMap);
      }
      renderControlBoardMulti(); attachStickyAnimation();
    }
    function countActiveNumbersInMap(seatsMap){
      var rows = getRowsToRenderFromMap(seatsMap); var count = 0;
      rows.forEach(function(row){ ['A','B','C','D'].forEach(function(letter){
        var code = row + letter; var st = computeClassForWith(seatsMap, code); if(st === 'libre' || st === 'ocupado') count++;
      }); });
      return count;
    }
    function renderControlBoardMulti(){
      var board = document.getElementById('controlBoard'); var container = document.getElementById('controlCroquisMulti'); var fb = document.getElementById('pdfLinkFallback');
      board.hidden = false; container.innerHTML = ''; fb.classList.add('hidden'); fb.innerHTML = '';
      CONTROL_EDIT = false; EDIT_SRC = null; EDIT_DST = null; updateEditTags(); syncToolbarUI();
      var btnExp = document.getElementById('btnExportPdf'); if (btnExp) btnExp.textContent = 'Exportar PDF (todas las plantas)';
      var ordered = []; var alta = STAFF_SHEETS.find(function(f){ return f.label.toLowerCase().indexOf('alta')>=0; }); var baja = STAFF_SHEETS.find(function(f){ return f.label.toLowerCase().indexOf('baja')>=0; });
      if (alta) ordered.push(alta); if (baja) ordered.push(baja);
      STAFF_SHEETS.forEach(function(f){ if (!ordered.find(function(o){ return o.sheetName === f.sheetName; })) ordered.push(f); });
      var seatOffset = 1;
      for (var i=0;i<ordered.length;i++){
        var f = ordered[i]; var seatsMap = STAFF_SEATS_BY_SHEET.get(f.sheetName) || {};
        var section = document.createElement('div'); section.className = 'form'; section.style.marginBottom = '12px';
        var title = document.createElement('h4'); title.textContent = f.label; title.style.margin = '0 0 8px 0';
        var grid = document.createElement('div'); grid.className = 'grid'; grid.setAttribute('aria-live','polite');
        section.appendChild(title); section.appendChild(grid); container.appendChild(section);
        buildControlGridForSheet(grid, f.sheetName, seatsMap, seatOffset);
        seatOffset += countActiveNumbersInMap(seatsMap);
      }
      board.scrollIntoView({behavior:'smooth'});
    }
    function buildControlGridForSheet(gridEl, sheetName, seatsMap, startNumber){
      gridEl.innerHTML = '';
      var rows = getRowsToRenderFromMap(seatsMap); if(rows.length === 0){ gridEl.innerHTML = '<p class="empty">No hay asientos cargados en la hoja.</p>'; return; }
      var seatNumber = (typeof startNumber === 'number' && startNumber > 0) ? startNumber : 1;
      function isNum(klass){ return (klass === 'libre' || klass === 'ocupado'); }
      function computeClassForWith(seatsMapLocal, code){
        var key = normalize(code);
        if(!seatsMapLocal.hasOwnProperty(key)) return 'inexistente';
        var st = (seatsMapLocal[key].estado || '').toLowerCase().trim();
        if(st === 'ocupado') return 'ocupado';
        if(st === 'inhabilitado') return 'inexistente';
        return 'libre';
      }
      rows.forEach(function(row){
        var rowEl = document.createElement('div'); rowEl.className = 'row';
        var left = document.createElement('div'); left.className = 'block';
        var right = document.createElement('div'); right.className = 'block';
        function renderSeat(letter, container){
          var code = row + letter;
          var norm = normalize(code);
          var klass= computeClassForWith(seatsMap, code);
          var btn=document.createElement('button'); btn.type='button'; btn.className='seat ' + klass;
          btn.setAttribute('data-code',code); btn.setAttribute('data-sheet',sheetName); btn.setAttribute('data-status',klass);
          if(isNum(klass)){
            var occFull = (seatsMap[norm] && seatsMap[norm].pasajero) || '';
            var occName = (klass==='ocupado') ? firstName(occFull) : '';
            btn.innerHTML =
              '<span class="num">'+seatNumber+'</span>' +
              (occName ? '<span class="occ-name">'+occName+'</span>' : '') +
              (occFull ? '<span class="occ-full" aria-hidden="true">'+occFull+'</span>' : '');
            btn.setAttribute('data-num',seatNumber);
            btn.setAttribute('aria-label','['+sheetName+'] Asiento '+code+' ('+seatNumber+') '+klass + (occName ? (' — Ocupa: '+occName) : ''));
            btn.setAttribute('aria-expanded','false');
            btn.disabled = false; seatNumber++;
          }else{
            btn.innerHTML=' '; btn.setAttribute('aria-label','['+sheetName+'] Asiento '+code+' inhabilitado/no disponible'); btn.disabled=true;
          }
          btn.onclick = function(){ if (CONTROL_EDIT) onControlSeatClick(btn); else toggleSeatExpand(btn); };
          container.appendChild(btn);
        }
        ['A','B'].forEach(function(l){ renderSeat(l, left); });
        var aisle=document.createElement('div'); aisle.className='aisle';
        ['C','D'].forEach(function(l){ renderSeat(l, right); });
        rowEl.appendChild(left); rowEl.appendChild(aisle); rowEl.appendChild(right); gridEl.appendChild(rowEl);
      });
    }

    /* Público: helpers numeración y croquis */
    async function countActiveNumbers(fileId, sheetName){
      try{
        var resp = await API.apiGetSeats(fileId, sheetName);
        var rows = resp.rows || []; var map = {};
        rows.forEach(function(r){ map[ normalize(r.asiento) ] = { estado: r.estado }; });
        var rowsActive = getRowsToRenderFromMap(map);
        var count = 0;
        rowsActive.forEach(function(row){ ['A','B','C','D'].forEach(function(letter){
          var code = row + letter; var st = computeClassForWith(map, code); if(st === 'libre' || st === 'ocupado') count++;
        }); });
        return count;
      }catch(e){ return 0; }
    }
    async function computeGridOptions(){
      if(!CURRENT_TRIP.hasFloors) return { offset:0, hideMissing:true };
      var floors = getFloorSheets();
      var alta = floors.find(function(f){ return f.sheetName.toLowerCase() === 'asientos alta'; });
      var baja = floors.find(function(f){ return f.sheetName.toLowerCase() === 'asientos baja'; });
      if(alta && baja && CURRENT_TRIP.sheetName && CURRENT_TRIP.sheetName.toLowerCase() === baja.sheetName.toLowerCase()){
        var offset = await countActiveNumbers(CURRENT_TRIP.fileId, alta.sheetName);
        return { offset: offset, hideMissing:true };
      }
      return { offset:0, hideMissing:true };
    }
    function computeClassForWith(seatsMap, code){
      var key = normalize(code);
      if(!seatsMap.hasOwnProperty(key)) return 'inexistente';
      var st = (seatsMap[key].estado || '').toLowerCase().trim();
      if(st === 'ocupado') return 'ocupado';
      if(st === 'inhabilitado') return 'inexistente';
      return 'libre';
    }

    async function chooseFloor(sheetName){
      CURRENT_TRIP.sheetName = sheetName; updateTripTags();
      var lbl = getFloorLabelFromSheetName(sheetName);
      if (CONTROL_AUTH) {
        showView('view-control'); showLoading('Cargando ocupación…');
        if (CURRENT_TRIP.hasFloors) { await refreshStaffMulti(); } else { await refreshSeats(null, function(){}, null); renderControlBoard(); }
        hideLoading(); setHash(['Staff', CURRENT_TRIP.name]);
      } else {
        if (CURRENT_TRIP.hasFloors) {
          showView('view-select'); showLoading('Cargando asientos…');
          var opts = await computeGridOptions(); refreshSeats('grid-select', function(){ hideLoading(); }, opts);
          setHash(['Selección de asientos', CURRENT_TRIP.name, lbl]);
        } else {
          goHome(); setHash([CURRENT_TRIP.name]);
        }
      }
    }
    function updateTripTags(){
      var tagTrip = document.getElementById('tagTrip'); var tagTripFloor = document.getElementById('tagTripFloor');
      var text = 'Viaje: ' + (CURRENT_TRIP.name || '—');
      if (tagTrip) tagTrip.textContent = text;
      if (tagTripFloor) tagTripFloor.textContent = text;
      syncStaffBadge();
    }
    async function goSelect(){
      if(!CURRENT_TRIP.fileId || !CURRENT_TRIP.sheetName){ setHash(['Inicio']); showView('view-choose'); return; }
      showView('view-select'); showLoading('Cargando asientos…');
      var opts = await computeGridOptions(); refreshSeats('grid-select', function(){ hideLoading(); }, opts);
      if (CURRENT_TRIP.hasFloors) setHash(['Selección de asientos', CURRENT_TRIP.name, getFloorLabelFromSheetName(CURRENT_TRIP.sheetName)]);
      else setHash(['Selección de asientos', CURRENT_TRIP.name]);
    }
    function goFind(){ if(!CURRENT_TRIP.fileId){ setHash(['Inicio']); showView('view-choose'); return; } showView('view-find'); clearFindView(); clearFindViewMulti(); }
    function goControl(){ openStaffLogin(); }

    async function refreshSeats(targetId, onDone, gridOptions){
      var gridEl = targetId ? document.getElementById(targetId) : null;
      if(gridEl) gridEl.setAttribute('aria-busy','true');
      try{
        var resp = await API.apiGetSeats(CURRENT_TRIP.fileId, CURRENT_TRIP.sheetName);
        var rows = resp.rows || [];
        SEATS = {};
        rows.forEach(function(r){ SEATS[ normalize(r.asiento) ] = { estado: r.estado, pasajero: r.pasajero || '', ci: r.ci || '' }; });
        if(gridEl){ buildGrid(targetId, gridOptions); }
      }catch(err){
        console.error('refreshSeats error:', err);
        toast('Error al cargar asientos: ' + (err && err.message ? err.message : 'desconocido'));
        if(gridEl){ buildGrid(targetId, gridOptions); }
      }finally{
        if (typeof onDone === 'function') { try { onDone(); } catch(e){} }
      }
    }
    async function refreshSeatsWithSpinner(targetId, onDone, gridOptions){
      showLoading('Actualizando asientos…');
      await refreshSeats(targetId, function(){ hideLoading(); if (typeof onDone === 'function') onDone(); }, gridOptions);
    }
    function getRowsToRenderFromMap(seatsMap){
      var rows = new Set();
      Object.keys(seatsMap || {}).forEach(function(code){
        var m = code.match(/^(\d+)[A-Z]$/); if(!m) return;
        var row = parseInt(m[1], 10);
        var estado = (seatsMap[code].estado || '').toLowerCase().trim();
        if(estado !== 'inhabilitado') rows.add(row);
      });
      return Array.from(rows).sort(function(a,b){ return a-b; });
    }
    function getRowsToRender(){ return getRowsToRenderFromMap(SEATS); }
    function computeClassFor(code){
      var key = normalize(code); var s = SEATS[key];
      if(!s) return 'inexistente';
      var st = (s.estado || '').toLowerCase().trim();
      if(st === 'ocupado') return 'ocupado';
      if(st === 'inhabilitado') return 'inhabilitado';
      return 'libre';
    }
    function getSeatState(code){
      var key = normalize(code); var s = SEATS[key];
      if(!s) return 'inexistente';
      var st = (s.estado || '').toLowerCase().trim();
      if(st === 'ocupado') return 'ocupado';
      if(st === 'inhabilitado') return 'inhabilitado';
      return 'libre';
    }
    function buildGrid(targetId, options){
      options = options || {};
      var offset = options.offset || 0;
      var hideMissing = (typeof options.hideMissing==='undefined') ? true : !!options.hideMissing;
      var grid = document.getElementById(targetId || 'grid-select'); if(!grid) return;
      grid.innerHTML = ''; grid.removeAttribute('aria-busy'); selected = new Set(); NUM_LABELS = new Map();
      var rows = getRowsToRender();
      if(rows.length === 0){ grid.innerHTML = '<p class="empty">No hay asientos cargados en la hoja.</p>'; return; }
      var seatNumber = 1 + offset;
      rows.forEach(function(row){
        var rowEl = document.createElement('div'); rowEl.className = 'row';
        var left = document.createElement('div'); left.className = 'block';
        var right = document.createElement('div'); right.className = 'block';
        function renderSeat(letter, container){
          var code = row + letter; var state = getSeatState(code);
          var isNum = (state === 'libre' || state === 'ocupado'); var norm = normalize(code);
          if(isNum){
            var btn = document.createElement('button'); btn.type='button'; btn.className = 'seat ' + state;
            btn.textContent = seatNumber;
            btn.setAttribute('data-code', code);
            btn.setAttribute('aria-label', 'Asiento ' + code + ' ('+seatNumber+') ' + state);
            NUM_LABELS.set(norm, seatNumber); seatNumber++;
            if(targetId === 'grid-select'){
              if(state === 'libre'){ btn.onclick = function(){ toggleSeat(code, btn); }; }
              else { btn.disabled = true; }
            } else { btn.disabled = true; }
            if(HIGHLIGHT_CODES.has(norm)){ btn.classList.add('mine'); }
            container.appendChild(btn); return;
          }
          if(state === 'inhabilitado'){
            var btn2 = document.createElement('button'); btn2.type='button'; btn2.className = 'seat inhabilitado';
            btn2.innerHTML = ' '; btn2.setAttribute('aria-label', 'Asiento ' + code + ' inhabilitado/no disponible'); btn2.disabled = true;
            container.appendChild(btn2); return;
          }
          if(state === 'inexistente' && hideMissing){
            var ph = document.createElement('div'); ph.className = 'seat-placeholder'; ph.setAttribute('aria-hidden','true');
            container.appendChild(ph); return;
          }
          var btn3 = document.createElement('button'); btn3.type='button'; btn3.className = 'seat inexistente';
          btn3.innerHTML = ' '; btn3.setAttribute('aria-label', 'Asiento ' + code + ' inexistente/no disponible'); btn3.disabled = true;
          container.appendChild(btn3);
        }
        ['A','B'].forEach(function(l){ renderSeat(l, left); });
        var aisle = document.createElement('div'); aisle.className = 'aisle';
        ['C','D'].forEach(function(l){ renderSeat(l, right); });
        rowEl.appendChild(left); rowEl.appendChild(aisle); rowEl.appendChild(right);
        grid.appendChild(rowEl);
      });
      if(HIGHLIGHT_CODES.size){
        var first = grid.querySelector('.seat.mine'); if(first) first.scrollIntoView({behavior:'smooth', block:'center'});
      }
    }

    function updateAssignVisibility(){ if(selected.size > 1){ document.getElementById('view-assign').classList.remove('hidden'); } else { document.getElementById('view-assign').classList.add('hidden'); } }
    function backToSelect(){ document.getElementById('view-assign').classList.add('hidden'); }
    function toggleSeat(code, el){
      var key = normalize(code);
      var isSel = selected.has(key);
      if(isSel){ selected.delete(key); el.classList.remove('seleccionado'); }
      else { selected.add(key); el.classList.add('seleccionado'); }
      updateAssignVisibility();
    }
    async function startSelection(){
      if(BUSY) return;
      if(selected.size === 0){ toast('Elegí al menos un asiento'); return; }
      var nombre = document.getElementById('nombrePrincipal').value.trim();
      var ci = document.getElementById('ciPrincipal').value.trim();
      if(!nombre || !ci){ toast('Completá nombre y CI'); return; }
      if(selected.size === 1){
        var only = Array.from(selected)[0]; var onlyNorm = normalize(only);
        var pairs = [{ asiento: onlyNorm, pasajero: nombre, ci: ci }];
        BUSY = true; showLoading('Reservando…');
        try{
          await API.apiReserve(CURRENT_TRIP.fileId, CURRENT_TRIP.sheetName, pairs);
          showReserveFeedbackDetailed(pairs);
          await refreshSelectGrid();
        }catch(err){ toast('No se pudo reservar'); }
        finally{ hideLoading(); BUSY = false; }
        return;
      }
      var assign = document.getElementById('assignList'); assign.innerHTML = '';
      var codes = Array.from(selected);
      for(var i=0;i<codes.length;i++){
        var codeNorm = normalize(codes[i]); var num = NUM_LABELS.get(codeNorm) || '';
        var row = document.createElement('div'); row.className = 'assign-row'; row.setAttribute('data-code', codeNorm);
        var title = document.createElement('div'); title.className = 'assign-title'; title.textContent = 'Asiento ' + (num || codeNorm);
        var grid = document.createElement('div'); grid.className = 'assign-grid';
        var nameWrap = document.createElement('label'); nameWrap.className = 'field';
        var nameLabel = document.createElement('span'); nameLabel.className = 'field-label'; nameLabel.textContent = 'Nombre';
        var nameInput = document.createElement('input'); nameInput.type='text'; nameInput.placeholder='Nombre y Apellido'; nameInput.required=true; nameInput.value = i===0 ? nombre : ''; nameInput.className='assign-name'; nameInput.autocapitalize='words'; nameInput.autocomplete='name';
        var ciWrap = document.createElement('label'); ciWrap.className = 'field';
        var ciLabel = document.createElement('span'); ciLabel.className = 'field-label'; ciLabel.textContent = 'CI';
        var ciInput = document.createElement('input'); ciInput.type='text'; ciInput.placeholder='Ej.: 12345678'; ciInput.required=true; ciInput.value = i===0 ? ci : ''; ciInput.className='assign-ci'; ciInput.inputMode='numeric'; ciInput.pattern='[0-9]*';
        ciInput.addEventListener('input', function(e){ onlyDigits(e.target); });
        nameWrap.appendChild(nameLabel); nameWrap.appendChild(nameInput);
        ciWrap.appendChild(ciLabel); ciWrap.appendChild(ciInput);
        grid.appendChild(nameWrap); grid.appendChild(ciWrap);
        row.appendChild(title); row.appendChild(grid); assign.appendChild(row);
      }
      document.getElementById('view-assign').classList.remove('hidden');
      document.getElementById('view-assign').scrollIntoView({behavior:'smooth'});
    }
    async function confirmReservation(){
      if(BUSY) return;
      var inputs = document.querySelectorAll('#assignList .assign-row');
      var pairs = [];
      for(var i=0;i<inputs.length;i++){
        var row = inputs[i];
        var codeNorm = row.getAttribute('data-code');
        var pasajero = row.querySelector('.assign-name').value.trim();
        var ci = row.querySelector('.assign-ci').value.trim();
        if(!pasajero || !ci){ toast('Faltan datos en ' + codeNorm); return; }
        pairs.push({ asiento: codeNorm, pasajero: pasajero, ci: ci });
      }
      BUSY = true; showLoading('Reservando…');
      try{
        await API.apiReserve(CURRENT_TRIP.fileId, CURRENT_TRIP.sheetName, pairs);
        showReserveFeedbackDetailed(pairs);
        document.getElementById('view-assign').classList.add('hidden');
        await refreshSelectGrid();
      }catch(err){ toast('No se pudo reservar'); }
      finally{ hideLoading(); BUSY = false; }
    }
    function showReserveFeedbackDetailed(pairs){
      var panel = document.getElementById('reserveFeedback'); var nums = document.getElementById('reserveNums'); nums.innerHTML = '';
      (pairs || []).forEach(function(p){
        var norm = normalize(p.asiento); var num = NUM_LABELS.get(norm);
        var pill = document.createElement('span'); pill.className = 'pill';
        pill.textContent = ((typeof num !== 'undefined') ? num : norm) + ' — ' + p.pasajero + ' (' + p.ci + ')';
        nums.appendChild(pill);
      });
      panel.classList.remove('hidden'); panel.scrollIntoView({behavior:'smooth'});
    }

    async function findByCI(){
      if(CURRENT_TRIP.hasFloors && !CURRENT_TRIP.sheetName){ await findByCIAcrossFloors(); return; }
      if(!CURRENT_TRIP.fileId || !CURRENT_TRIP.sheetName){ setHash(['Inicio']); showView('view-choose'); return; }
      var ci = document.getElementById('ciSearch').value.trim();
      if(!ci){ toast('Ingresá tu CI'); return; }
      showLoading('Buscando…');
      try{
        var respSeats = await API.apiGetSeatsByCi(CURRENT_TRIP.fileId, CURRENT_TRIP.sheetName, ci);
        var rawCodes = (respSeats.seats || []).map(function(s){ return normalize(s); });
        LAST_FOUND_CODES = Array.from(new Set(rawCodes));
        var respRows = await API.apiGetSeats(CURRENT_TRIP.fileId, CURRENT_TRIP.sheetName);
        var rows = respRows.rows || [];
        SEATS = {}; rows.forEach(function(r){ SEATS[ normalize(r.asiento) ] = { estado: r.estado, pasajero: r.pasajero || '', ci: r.ci || '' }; });
        var nums = computeNumbersForCodes(LAST_FOUND_CODES); renderFindFeedback(nums);
        HIGHLIGHT_CODES = new Set(LAST_FOUND_CODES);
      }catch(err){ toast('Error al buscar por CI'); }
      finally{ hideLoading(); }
    }
    function computeNumbersForCodes(codes){
      NUM_LABELS = new Map();
      var rows = getRowsToRender(); var seatNumber = 1;
      function isNum(klass){ return (klass === 'libre' || klass === 'ocupado'); }
      rows.forEach(function(row){ ['A','B','C','D'].forEach(function(letter){
        var code = row + letter; var klass = computeClassFor(code); var norm = normalize(code);
        if(isNum(klass)){ NUM_LABELS.set(norm, seatNumber); seatNumber++; }
      }); });
      return codes.map(function(c){ return NUM_LABELS.get(c); }).filter(function(n){ return typeof n !== 'undefined'; });
    }
    function renderFindFeedback(nums){
      var panel = document.getElementById('findFeedback'); var list = document.getElementById('findNums'); var btn = document.getElementById('btnShowCroquis');
      list.innerHTML = '';
      if(nums.length){
        nums.forEach(function(n){ var pill = document.createElement('span'); pill.className='pill'; pill.textContent = String(n); list.appendChild(pill); });
        panel.classList.remove('hidden'); btn.disabled = false; panel.scrollIntoView({behavior:'smooth'});
      }else{
        panel.classList.remove('hidden'); list.innerHTML = '<span class="pill">Sin asientos</span>'; btn.disabled = true;
      }
    }
    function showCroquisForCI(){
      showLoading('Cargando croquis…');
      refreshSeats('grid-find', function(){
        hideLoading();
        var firstMarked = document.getElementById('grid-find').querySelector('.seat.mine');
        if (firstMarked) firstMarked.scrollIntoView({ behavior:'smooth', block:'center' });
        else document.getElementById('grid-find').scrollIntoView({ behavior:'smooth', block:'start' });
        toast('Resaltados: ' + HIGHLIGHT_CODES.size);
      });
    }
    function clearFindView(){ document.getElementById('findFeedback').classList.add('hidden'); document.getElementById('findNums').innerHTML = ''; document.getElementById('grid-find').innerHTML = ''; HIGHLIGHT_CODES = new Set(); LAST_FOUND_CODES = []; }

    var MULTI_SHEETS = []; var SEATS_BY_SHEET = new Map(); var HIGHLIGHT_BY_SHEET = new Map(); var NUMS_BY_SHEET = new Map();
    async function findByCIAcrossFloors(){
      if(!CURRENT_TRIP.fileId){ setHash(['Inicio']); showView('view-choose'); return; }
      var ci = document.getElementById('ciSearch').value.trim(); if(!ci){ toast('Ingresá tu CI'); return; }
      showLoading('Buscando en ambas plantas…');
      try{
        MULTI_SHEETS = getFloorSheets(); SEATS_BY_SHEET = new Map(); HIGHLIGHT_BY_SHEET = new Map(); NUMS_BY_SHEET = new Map();
        for(var i=0;i<MULTI_SHEETS.length;i++){
          var f = MULTI_SHEETS[i];
          var respSeats = await API.apiGetSeatsByCi(CURRENT_TRIP.fileId, f.sheetName, ci);
          var respRows = await API.apiGetSeats(CURRENT_TRIP.fileId, f.sheetName);
          var codesRaw = (respSeats.seats || []).map(function(s){ return normalize(s); });
          var codes = Array.from(new Set(codesRaw));
          var rows = respRows.rows || []; var seatsMap = {};
          rows.forEach(function(r){ seatsMap[ normalize(r.asiento) ] = { estado: r.estado, pasajero: r.pasajero || '', ci: r.ci || '' }; });
          SEATS_BY_SHEET.set(f.sheetName, seatsMap);
          HIGHLIGHT_BY_SHEET.set(f.sheetName, new Set(codes));
          var nums = computeNumbersForCodesWith(seatsMap, codes); NUMS_BY_SHEET.set(f.sheetName, nums);
        }
        renderFindFeedbackMulti();
      }catch(err){ toast('Error al buscar en ambas plantas'); }
      finally{ hideLoading(); }
    }
    function computeNumbersForCodesWith(seatsMap, codes){
      var rows = getRowsToRenderFromMap(seatsMap); var seatNumber = 1; var labels = new Map();
      function isNum(klass){ return (klass === 'libre' || klass === 'ocupado'); }
      rows.forEach(function(row){ ['A','B','C','D'].forEach(function(letter){
        var code = row + letter; var klass = computeClassForWith(seatsMap, code); var norm = normalize(code);
        if(isNum(klass)){ labels.set(norm, seatNumber); seatNumber++; }
      }); });
      return codes.map(function(c){ return labels.get(c); }).filter(function(n){ return typeof n !== 'undefined'; });
    }
    function renderFindFeedbackMulti(){
      clearFindView();
      var panel = document.getElementById('multiFeedback'); var wrap = document.getElementById('multiNums'); var btn = document.getElementById('btnShowCroquisMulti');
      wrap.innerHTML = ''; var totalResults = 0;
      var floors = MULTI_SHEETS;
      floors.forEach(function(f){
        var nums = NUMS_BY_SHEET.get(f.sheetName) || []; totalResults += nums.length;
        var section = document.createElement('div'); section.className = 'form'; section.style.marginBottom = '12px';
        var title = document.createElement('h4'); title.textContent = f.label; title.style.margin = '0 0 8px 0';
        var list = document.createElement('div'); list.className = 'nums';
        if(nums.length){ nums.forEach(function(n){ var pill = document.createElement('span'); pill.className='pill'; pill.textContent = String(n); list.appendChild(pill); }); }
        else { var pill2 = document.createElement('span'); pill2.className='pill'; pill2.textContent = 'Sin asientos'; list.appendChild(pill2); }
        section.appendChild(title); section.appendChild(list); wrap.appendChild(section);
      });
      panel.classList.remove('hidden'); btn.disabled = (totalResults === 0); panel.scrollIntoView({behavior:'smooth'});
    }
    async function showCroquisForCIMulti(){
      showLoading('Cargando croquis…');
      var container = document.getElementById('multiCroquis'); container.innerHTML = '';
      var floorsWithResults = MULTI_SHEETS.filter(function(f){ var found = NUMS_BY_SHEET.get(f.sheetName) || []; return found.length > 0; });
      if (!floorsWithResults.length) { hideLoading(); toast('Tu CI no tiene asientos en ninguna planta de este viaje.'); return; }
      for(var i=0;i<floorsWithResults.length;i++){
        var f = floorsWithResults[i];
        var seatsMap = SEATS_BY_SHEET.get(f.sheetName) || {};
        var highlights = HIGHLIGHT_BY_SHEET.get(f.sheetName) || new Set();
        var form = document.createElement('div'); form.className = 'form'; form.style.marginBottom = '12px';
        var title = document.createElement('h4'); title.textContent = f.label; title.style.margin = '0 0 8px 0';
        var gridId = 'grid-find-' + normalize(f.label).toLowerCase();
        var grid = document.createElement('div'); grid.id = gridId; grid.className = 'grid'; grid.setAttribute('aria-live','polite');
        form.appendChild(title); form.appendChild(grid); container.appendChild(form);
        buildGridCustom(gridId, seatsMap, highlights);
      }
      hideLoading();
      var firstMarked = container.querySelector('.seat.mine');
      if (firstMarked) { firstMarked.scrollIntoView({ behavior:'smooth', block:'center' }); }
      else { container.scrollIntoView({ behavior:'smooth', block:'start' }); }
    }
    function buildGridCustom(targetId, seatsMap, highlightSet){
      var grid = document.getElementById(targetId); if(!grid) return;
      grid.innerHTML = '';
      var rows = getRowsToRenderFromMap(seatsMap);
      if(rows.length === 0){ grid.innerHTML = '<p class="empty">No hay asientos cargados en la hoja.</p>'; return; }
      var seatNumber = 1;
      rows.forEach(function(row){
        var rowEl = document.createElement('div'); rowEl.className = 'row';
        var left = document.createElement('div'); left.className = 'block';
        var right = document.createElement('div'); right.className = 'block';
        function renderSeat(letter, container){
          var code = row + letter; var klass = computeClassForWith(seatsMap, code);
          var btn = document.createElement('button'); btn.type='button'; btn.className = 'seat ' + klass;
          var isNum = (klass === 'libre' || klass === 'ocupado'); var norm = normalize(code);
          if(isNum){
            btn.textContent = seatNumber;
            btn.setAttribute('data-code', code);
            btn.setAttribute('aria-label', 'Asiento ' + code + ' ('+seatNumber+') ' + klass);
            seatNumber++; btn.disabled = true;
          }else{
            btn.innerHTML = ' '; btn.setAttribute('aria-label', 'Asiento ' + code + ' inhabilitado/no disponible'); btn.disabled = true;
          }
          if(highlightSet.has(norm)){ btn.classList.add('mine'); }
          container.appendChild(btn);
        }
        ['A','B'].forEach(function(l){ renderSeat(l, left); });
        var aisle = document.createElement('div'); aisle.className = 'aisle';
        ['C','D'].forEach(function(l){ renderSeat(l, right); });
        rowEl.appendChild(left); rowEl.appendChild(aisle); rowEl.appendChild(right);
        grid.appendChild(rowEl);
      });
      var first = grid.querySelector('.seat.mine'); if(first) first.scrollIntoView({behavior:'smooth', block:'center'});
    }
    function clearFindViewMulti(){
      document.getElementById('multiFeedback').classList.add('hidden');
      document.getElementById('multiNums').innerHTML = '';
      document.getElementById('multiCroquis').innerHTML = '';
      MULTI_SHEETS = []; SEATS_BY_SHEET = new Map(); HIGHLIGHT_BY_SHEET = new Map(); NUMS_BY_SHEET = new Map();
    }

    function renderControlBoard(){
      if(!CONTROL_AUTH){ hideControlBoard(); return; }
      STAFF_CONTROL_MULTI = false; STAFF_ACTIVE_SHEET = CURRENT_TRIP.sheetName;
      var board = document.getElementById('controlBoard'); var croquis= document.getElementById('controlCroquis'); var multi = document.getElementById('controlCroquisMulti'); var fb = document.getElementById('pdfLinkFallback');
      board.hidden = false; croquis.innerHTML = ''; multi.innerHTML = ''; fb.classList.add('hidden'); fb.innerHTML = '';
      CONTROL_EDIT=false; EDIT_SRC=null; EDIT_DST=null; updateEditTags(); syncToolbarUI();
      var btnExp = document.getElementById('btnExportPdf'); if (btnExp) btnExp.textContent = 'Exportar PDF';
      var maxRow = getMaxRow(); if(maxRow === 0){ croquis.innerHTML = '<p class="empty">No hay asientos cargados en la hoja.</p>'; return; }
      NUM_LABELS = new Map(); var seatNumber = 1;
      for(var row=1; row<=maxRow; row++){
        var rowEl=document.createElement('div'); rowEl.className='row';
        var left=document.createElement('div'); left.className='block';
        var right=document.createElement('div'); right.className='block';
        function renderSeat(letter, container){
          var code = row + letter; var norm = normalize(code);
          var klass= computeClassFor(code); var isNum= (klass==='libre' || klass==='ocupado');
          var btn=document.createElement('button'); btn.type='button'; btn.className='seat ' + klass;
          btn.setAttribute('data-sheet', CURRENT_TRIP.sheetName || '');
          btn.setAttribute('data-code',code); btn.setAttribute('data-status',klass);
          if(isNum){
            var occFull = (SEATS[norm] && SEATS[norm].pasajero) || '';
            var occName = (klass==='ocupado') ? firstName(occFull) : '';
            btn.innerHTML =
              '<span class="num">'+seatNumber+'</span>' +
              (occName ? '<span class="occ-name">'+occName+'</span>' : '') +
              (occFull ? '<span class="occ-full" aria-hidden="true">'+occFull+'</span>' : '');
            btn.setAttribute('data-num',seatNumber);
            btn.setAttribute('aria-label','Asiento '+code+' ('+seatNumber+') '+klass + (occName ? (' — Ocupa: '+occName) : ''));
            btn.setAttribute('aria-expanded','false');
            btn.disabled = false;
            NUM_LABELS.set(norm,seatNumber); seatNumber++;
          }else{
            btn.innerHTML=' '; btn.setAttribute('aria-label','Asiento '+code+' inhabilitado/no disponible'); btn.disabled=true;
          }
          btn.onclick=function(){ if (CONTROL_EDIT) onControlSeatClick(btn); else toggleSeatExpand(btn); };
          container.appendChild(btn);
        }
        ['A','B'].forEach(function(l){ renderSeat(l,left); });
        var aisle=document.createElement('div'); aisle.className='aisle';
        ['C','D'].forEach(function(l){ renderSeat(l,right); });
        rowEl.appendChild(left); rowEl.appendChild(aisle); rowEl.appendChild(right);
        croquis.appendChild(rowEl);
      }
      board.scrollIntoView({behavior:'smooth'}); attachStickyAnimation();
    }
    function getMaxRow(){ var maxRow = 0; Object.keys(SEATS).forEach(function(code){ var m = code.match(/^(\d+)[A-Z]$/); if(m){ var row = parseInt(m[1],10); if(row > maxRow) maxRow = row; } }); return maxRow || 0; }
    function attachStickyAnimation(){
      var toolbar = document.getElementById('controlToolbar');
      function onScroll(){ var y=window.scrollY; if(y>24){ toolbar.classList.add('scrolled'); } else { toolbar.classList.remove('scrolled'); } }
      window.addEventListener('scroll', onScroll, { passive:true }); onScroll();
    }
    function hideControlBoard(){
      var board = document.getElementById('controlBoard'); board.hidden = true;
      document.getElementById('controlCroquis').innerHTML=''; document.getElementById('controlCroquisMulti').innerHTML='';
      var fb=document.getElementById('pdfLinkFallback'); fb.classList.add('hidden'); fb.innerHTML='';
      hideSeatTooltip(); CONTROL_EDIT=false; EDIT_SRC=null; EDIT_DST=null; updateEditTags(); syncToolbarUI();
    }
    function toggleControlEdit(){ CONTROL_EDIT=!CONTROL_EDIT; hideSeatTooltip(); updateEditTags(); syncToolbarUI(); toast(CONTROL_EDIT ? 'Modo edición activo' : 'Modo edición desactivado'); }
    function onControlSeatClick(btn){
      if(!CONTROL_EDIT) return;
      var status=(btn.getAttribute('data-status') || 'libre').toLowerCase().trim();
      var num =parseInt(btn.getAttribute('data-num') || '0',10);
      var code =btn.getAttribute('data-code');
      var sheet = btn.getAttribute('data-sheet') || CURRENT_TRIP.sheetName || null;
      STAFF_ACTIVE_SHEET = sheet;
      if(status==='ocupado'){
        var srcEls = document.querySelectorAll('.seat.pick-source'); for(var i=0;i<srcEls.length;i++){ srcEls[i].classList.remove('pick-source'); }
        btn.classList.add('pick-source'); EDIT_SRC={num:num,code:code,sheet:sheet};
      }else if(status==='libre'){
        var dstEls = document.querySelectorAll('.seat.pick-target'); for(var j=0;j<dstEls.length;j++){ dstEls[j].classList.remove('pick-target'); }
        btn.classList.add('pick-target'); EDIT_DST={num:num,code:code,sheet:sheet};
      }else{ return; }
      updateEditTags(); syncToolbarUI();
    }
    function updateEditTags(){
      var tagSrc=document.getElementById('tagSrc'), tagDst=document.getElementById('tagDst');
      tagSrc.textContent='Origen: ' + (EDIT_SRC ? (EDIT_SRC.num + ' • ' + EDIT_SRC.code) : '—');
      tagDst.textContent='Destino: ' + (EDIT_DST ? (EDIT_DST.num + ' • ' + EDIT_DST.code) : '—');
    }
    function syncToolbarUI(){
      var btnEdit=document.getElementById('btnEditMode');
      var btnMove=document.getElementById('btnMove');
      var btnFree=document.getElementById('btnFree');
      var btnCancel=document.getElementById('btnCancel');
      var toolbar=document.getElementById('controlToolbar');
      toolbar.classList.toggle('editing', CONTROL_EDIT);
      if(CONTROL_EDIT){
        btnEdit.style.background='#ef4444'; btnEdit.textContent='Salir de edición';
        var canMove = EDIT_SRC && EDIT_DST && (!STAFF_CONTROL_MULTI || (EDIT_SRC.sheet === EDIT_DST.sheet));
        btnMove.disabled=!canMove; btnFree.disabled=!EDIT_SRC; btnCancel.disabled=false;
      }else{
        btnEdit.style.background='#10b981'; btnEdit.textContent='Modo edición';
        btnMove.disabled=true; btnFree.disabled=true; btnCancel.disabled=true;
      }
    }
    function cancelEdit(silent){
      EDIT_SRC=null; EDIT_DST=null;
      var srcEls = document.querySelectorAll('.seat.pick-source'); for(var i=0;i<srcEls.length;i++){ srcEls[i].classList.remove('pick-source'); }
      var dstEls = document.querySelectorAll('.seat.pick-target'); for(var j=0;j<dstEls.length;j++){ dstEls[j].classList.remove('pick-target'); }
      updateEditTags(); syncToolbarUI();
      if(!silent) toast('Edición cancelada.');
    }
    async function movePassenger(){
      showLoading('Moviendo pasajero…');
      if(!EDIT_SRC || !EDIT_DST){ hideLoading(); toast('Selecciona origen (ocupado) y destino (libre).'); return; }
      if (STAFF_CONTROL_MULTI && EDIT_SRC.sheet !== EDIT_DST.sheet) { hideLoading(); toast('Debes elegir origen y destino en la misma planta.'); return; }
      try{
        var sheet = STAFF_CONTROL_MULTI ? EDIT_SRC.sheet : CURRENT_TRIP.sheetName;
        var resp=await API.apiMove(CURRENT_TRIP.fileId, sheet, EDIT_SRC.code, EDIT_DST.code);
        toast(resp && resp.message ? resp.message : 'Movimiento realizado');
        cancelEdit(true); await refreshControlBoardSmart();
      }catch(err){ toast('No se pudo mover al pasajero'); }
      finally{ hideLoading(); }
    }
    async function freeSelectedSeat(){
      showLoading('Liberando asiento…');
      if(!EDIT_SRC){ hideLoading(); toast('Selecciona primero un asiento ocupado (origen) para liberar.'); return; }
      try{
        var sheet = STAFF_CONTROL_MULTI ? EDIT_SRC.sheet : CURRENT_TRIP.sheetName;
        var resp=await API.apiFree(CURRENT_TRIP.fileId, sheet, EDIT_SRC.code);
        toast(resp && resp.message ? resp.message : 'Asiento liberado');
        cancelEdit(true); await refreshControlBoardSmart();
      }catch(err){ toast('No se pudo liberar el asiento'); }
      finally{ hideLoading(); }
    }

    async function doExportPdfSmart(){
      if(!CONTROL_AUTH){ toast('Debes iniciar sesión'); return; }
      showLoading('Generando PDF…');
      try{
        if (STAFF_CONTROL_MULTI) {
          var floors = getFloorSheets(); var urls = [];
          for (var i=0;i<floors.length;i++){
            var f = floors[i]; var resp = await API.apiExportPdf(CURRENT_TRIP.fileId, f.sheetName);
            if(resp && resp.url){ urls.push({ label: f.label, url: resp.url }); }
          }
          if(urls.length){
            var openedAll = true;
            for (var j=0;j<urls.length;j++){ var w = window.open(urls[j].url,'_blank'); if(!w) openedAll = false; }
            if(!openedAll){
              var fb=document.getElementById('pdfLinkFallback'); var listHtml = '';
              for(var k=0;k<urls.length;k++){ var u = urls[k]; listHtml += '<li><a href="'+u.url+'" target="_blank" rel="noopener">'+u.label+'</a></li>'; }
              fb.innerHTML='Tus PDFs están listos:<ul style="margin:8px 0;padding-left:16px;">'+listHtml+'</ul>'; fb.classList.remove('hidden');
            } else { toast('PDFs listos ('+urls.length+')'); }
          } else { toast('No se pudo generar los PDFs'); }
        } else {
          var sheet = CURRENT_TRIP.sheetName; var resp2 = await API.apiExportPdf(CURRENT_TRIP.fileId, sheet);
          if(resp2 && resp2.url){
            var newWin=window.open(resp2.url,'_blank');
            if(!newWin){ var fb2=document.getElementById('pdfLinkFallback'); fb2.innerHTML='Tu PDF está listo: <a href="'+resp2.url+'" target="_blank" rel="noopener">Abrir PDF</a>'; fb2.classList.remove('hidden'); }
            else { toast('PDF listo'); }
          }else{ toast(resp2 && resp2.message ? resp2.message : 'No se pudo generar el PDF'); }
        }
      }catch(err){ toast('Error al generar PDF'); }
      finally{ hideLoading(); }
    }
    async function refreshControlBoardSmart(){
      if (STAFF_CONTROL_MULTI) { await refreshStaffMulti(); }
      else { await refreshSeatsWithSpinner(null, renderControlBoard); }
    }
    async function refreshSelectGrid(){ var opts = await computeGridOptions(); await refreshSeatsWithSpinner('grid-select', function(){}, opts); }

    /* Admin buttons */
    function wireAdminMenuButtons(){
      var bLogin = document.getElementById('btnAdminLogin');
      var bInicio = document.getElementById('btnAdminControl');
      var bLogout = document.getElementById('btnAdminLogout');
      if (bLogin) bLogin.addEventListener('click', function(){ try { openStaffLogin(); hideAdminMenu(); } catch(e){} });
      if (bInicio) bInicio.addEventListener('click', function(){ try { backToChoose(); hideAdminMenu(); } catch(e){} });
      if (bLogout) bLogout.addEventListener('click', function(){ try { doControlLogout(); hideAdminMenu(); } catch(e){} });
    }

    /* ===== Staff: login / logout ===== */
    window.STAFF_ID_TOKEN = null;
    function withIdToken(payload) { payload = payload || {}; if (window.STAFF_ID_TOKEN) payload.idToken = window.STAFF_ID_TOKEN; return payload; }

    // Callback GIS (ID Token)
    async function handleCredentialResponse(response) {
      try {
        const idToken = response && response.credential;
        if (!idToken) { toast('No se recibió el token de Google'); return; }
        window.STAFF_ID_TOKEN = idToken;
        showLoading('Verificando…');
        const resp = await API.apiLoginWithToken(idToken);
        if (resp && resp.ok) {
          CONTROL_AUTH = true; setStaffSession(true); updateAdminMenu(); syncStaffBadge();
          toast('Acceso staff habilitado');
          showView('view-choose'); await loadTrips(); hideControlBoard(); setHash(['Inicio']);
        } else {
          CONTROL_AUTH = false; setStaffSession(false); updateAdminMenu(); syncStaffBadge(); hideControlBoard();
          toast(resp && resp.message ? resp.message : 'No autorizado');
        }
      } catch (e) {
        CONTROL_AUTH = false; setStaffSession(false); updateAdminMenu(); syncStaffBadge(); hideControlBoard();
        toast('Error de verificación');
      } finally { hideLoading(); }
    }

    function openStaffLogin(){
      hideAdminMenu();
      CONTROL_AUTH = false; setStaffSession(false); updateAdminMenu(); syncStaffBadge();
      hideControlBoard(); showView('view-control'); setHash(['Staff']);
    }
    function doControlLogout(){
      CONTROL_AUTH = false; setStaffSession(false); updateAdminMenu(); syncStaffBadge();
      window.STAFF_ID_TOKEN = null;
      hideControlBoard(); toast('Sesión finalizada'); backToChoose();
    }

    /* ===== Inicio ===== */
    (async function init(){
      var chip = document.querySelector('.brand-chip');
      var img = document.getElementById('heroLogo'); var skel = document.getElementById('logoSkeleton');
      img.addEventListener('click', function(ev){ ev.stopPropagation(); toggleAdminMenu(); });
      document.addEventListener('click', function(ev){ var menu = document.getElementById('adminMenu'); if (!chip.contains(ev.target)) { menu.classList.add('hidden'); } }, { passive:true });
      var pressTimer = null;
      img.addEventListener('touchstart', function(){ pressTimer = setTimeout(function(){ toggleAdminMenu(); }, 450); }, {passive:true});
      img.addEventListener('touchend', function(){ clearTimeout(pressTimer); }, {passive:true});

      try{
        var payload = await API.apiGetLogo(); var src = '';
        if (payload && payload.dataUrl) src = payload.dataUrl; else if (payload && payload.publicUrl) src = payload.publicUrl;
        if (src) { img.onload = function(){ img.classList.add('ready'); skel.style.display='none'; }; img.src = src; }
        else { skel.style.display='block'; }
      }catch(e){ skel.style.display='block'; }

      var ciP = document.getElementById('ciPrincipal'); if (ciP) ciP.addEventListener('input', function(e){ onlyDigits(e.target); });
      var ciS = document.getElementById('ciSearch');   if (ciS) ciS.addEventListener('input', function(e){ onlyDigits(e.target); });

      wireAdminMenuButtons(); wireStaffExpandAutoCollapse();
      await loadTrips();
      window.addEventListener('hashchange', function(){ if (!ROUTER_DRIVING) routeTo(location.hash); }, { passive:true });
      await routeTo(location.hash);

      if (isStaffSession()) { CONTROL_AUTH = true; updateAdminMenu(); syncStaffBadge(); }
      else { updateAdminMenu(); syncStaffBadge(); }
    })();
  </script>
</body>
</html>
