
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Selección de Asientos</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>

  <!-- ===== CSS embebido (mobile-first) ===== -->
  <style>
    :root{
      --bg:#f7f9fc; --card:#ffffff; --text:#1f2937; --muted:#6b7280;
      --primary:#2c7be5; --success:#10b981; --shadow:0 8px 20px rgba(17,24,39,.08);

      /* Paleta suave para fondo del header */
      --brandA: rgba(44,123,229,.10);  /* azul leve */
      --brandB: rgba(16,185,129,.08);  /* verde leve */

      /* Tamaño del logo (ajustá estas 3 si querés) */
      --logo-min: 64px;   /* mínimo */
      --logo-ideal: 12vw; /* ideal responsive */
      --logo-max: 160px;  /* máximo */
    }

    html,body{height:100%;}
    body{
      margin:0;
      font-family: system-ui,-apple-system, Segoe UI, Roboto, Ubuntu,'Helvetica Neue', Arial,'Noto Sans',sans-serif;
      color:var(--text);
      background:var(--bg);
    }

    /* ===== Cabecera (logo natural, centrado y más grande) ===== */
    .hero{
      width:100%;
      /* Fondo sutil en gradiente */
      background: linear-gradient(180deg, var(--brandA) 0%, var(--brandB) 45%, rgba(255,255,255,0) 100%);
      padding:clamp(16px,4vw,28px);
      /* Centrado perfecto con grid */
      display:grid; place-items:center;
      /* Altura mínima para que el logo respire */
      min-height: clamp(96px, 22vw, 220px);
    }
    .brand-chip{
      display:inline-flex; align-items:center; justify-content:center;
      padding:clamp(10px,2.6vw,18px) clamp(14px,3.4vw,24px);
      border-radius:18px;
      /* Efecto glass */
      background: rgba(255,255,255,.55);
      border:1px solid rgba(255,255,255,.65);
      backdrop-filter: saturate(160%) blur(8px);
      -webkit-backdrop-filter: saturate(160%) blur(8px);
      box-shadow:0 8px 24px rgba(17,24,39,.12);
    }
    .brand-chip img{
      height: clamp(var(--logo-min), var(--logo-ideal), var(--logo-max)); /* << tamaño del logo */
      width:auto; display:block; object-fit:contain;
      /* “Levanta” el PNG con sombra suave del propio contorno */
      filter: drop-shadow(0 3px 8px rgba(17,24,39,.14));
    }

    /* Contenedor principal */
    .app{padding:clamp(12px,3vw,20px);}
    .view{display:none;}
    .view.active{display:block; animation:fadeIn .4s ease both;}
    @keyframes fadeIn{from{opacity:0; transform:translateY(6px);} to{opacity:1; transform:none;}}

    /* Inicio centrado */
    .home-center{min-height:calc(100dvh - 160px); display:grid; place-items:center;}
    .cards{display:grid; grid-template-columns:1fr; gap:14px; max-width:480px; width:100%;}
    .card{
      background:var(--card); border-radius:14px; box-shadow:var(--shadow);
      padding:18px; display:flex; flex-direction:column; gap:8px;
      cursor:pointer; transition:transform .15s ease, box-shadow .2s ease; text-align:center;
    }
    .card:hover{transform:translateY(-2px); box-shadow:0 10px 24px rgba(17,24,39,.12);}
    .card h2{margin:0; font-size:1.15rem;}
    .card p{margin:0; color:var(--muted);}

    /* Formularios */
    .form{background:var(--card); border-radius:14px; box-shadow:var(--shadow); padding:16px; margin-bottom:12px;}
    .form-row{display:flex; flex-direction:column; gap:6px; margin-bottom:10px;}
    label{font-weight:600;}
    input{border:1px solid #e5e7eb; border-radius:10px; padding:12px; font-size:1rem; background:#fff; color:var(--text);}
    .actions{display:flex; gap:8px; flex-wrap:wrap;}
    .btn{border:none; border-radius:10px; padding:12px 14px; font-weight:600; cursor:pointer;}
    .btn.primary{background:var(--primary); color:white;}
    .btn.ghost{background:transparent; border:1px solid #e5e7eb; color:var(--text);}
    .btn.success{background:var(--success); color:white;}
    .btn.danger{background:#ef4444; color:white;}

    /* Leyenda */
    .legend{display:flex; gap:8px; margin:8px 0 12px; flex-wrap:wrap;}
    .badge{display:inline-flex; align-items:center; gap:6px; border-radius:999px; padding:6px 10px; font-size:.875rem;}
    .badge.libre{background:#d1fae5; color:#065f46;}
    .badge.ocupado{background:#fee2e2; color:#7f1d1d;}
    .badge.seleccionado{background:#dbeafe; color:#1e40af;}
    .badge.inexistente{background:#e5e7eb; color:#374151;}

    /* Grid de asientos (croquis) */
    .grid{display:flex; flex-direction:column; gap:8px;}
    .row{display:grid; grid-template-columns:1fr 24px 1fr; gap:8px; align-items:center;}
    .block{display:grid; grid-template-columns:repeat(2, 1fr); gap:8px;}
    .aisle{width:24px; height:24px;}
    .seat{
      border:none; border-radius:12px; padding:12px; font-weight:700; box-shadow:var(--shadow);
      transition:transform .1s ease, box-shadow .2s ease, background .2s ease, color .2s ease;
    }
    .seat.libre{background:#e6fffa; color:#0f766e;}
    .seat.ocupado{background:#fee2e2; color:#7f1d1d; cursor:not-allowed;}
    .seat.seleccionado{background:#dbeafe; color:#1e40af; transform:scale(1.02);}
    .seat.inexistente{background:#f3f4f6; color:#6b7280; cursor:not-allowed; opacity:.9;}
    .seat:active{transform:scale(0.98);}

    /* Control interno - tablero */
    .control-board{background:var(--card); border-radius:14px; box-shadow:var(--shadow); padding:16px 12px; margin-top:12px;}
    .control-actions{display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; margin-bottom:12px;}
    .control-grid{display:grid; grid-template-columns:repeat(2, minmax(0, 1fr)); gap:10px; margin-top:14px;}
    @media (min-width: 960px){ .control-grid{grid-template-columns:repeat(3, minmax(0, 1fr));} }
    .item{display:flex; align-items:center; justify-content:flex-start; gap:10px; border:1px solid #e5e7eb; border-radius:12px; padding:10px; transition:box-shadow .2s ease, transform .1s ease, outline-color .2s ease;}
    .item .num{min-width:40px; text-align:center; font-weight:700; border-radius:999px; padding:6px 10px;}
    .item .label{font-weight:600;}
    .item.occupied{background:#fee2e2; outline:2px solid #fecaca;}
    .item.occupied .num{background:#fecaca; color:#7f1d1d;}
    .item.occupied .label{color:#7f1d1d;}
    .item.free{background:#d1fae5; outline:2px solid #a7f3d0;}
    .item.free .num{background:#a7f3d0; color:#065f46;}
    .item.free .label{color:#065f46;}
    .item.pick-source{outline:3px solid #f59e0b; box-shadow:0 0 0 3px rgba(245,158,11,.20) inset;}
    .item.pick-target{outline:3px solid #2563eb; box-shadow:0 0 0 3px rgba(37,99,235,.20) inset;}

    /* Snackbar */
    .snackbar{position:fixed; left:50%; bottom:20px; transform:translateX(-50%);
      background:#111827; color:#fff; padding:12px 16px; border-radius:12px; box-shadow:var(--shadow);
      opacity:0; pointer-events:none;}
    .snackbar.show{opacity:1; transition:opacity .2s ease;}

    /* Overlay de carga */
    .overlay{
      position:fixed; inset:0; background:rgba(17,24,39,.28);
      display:grid; place-items:center; opacity:0; pointer-events:none;
      transition:opacity .15s ease;
    }
    .overlay.show{opacity:1; pointer-events:auto;}
    .loader{
      background:var(--card); border-radius:14px; box-shadow:var(--shadow);
      padding:16px 18px; display:flex; align-items:center; gap:12px;
    }
    .spinner{
      width:20px; height:20px; border-radius:50%;
      border:3px solid #c7d2fe; border-top-color:#3b82f6;
      animation:spin .9s linear infinite; -webkit-animation:spin .9s linear infinite; will-change:transform;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    @-webkit-keyframes spin { to { -webkit-transform: rotate(360deg); transform: rotate(360deg); } }
    .loader-text{font-weight:600; color:#111827;}

    /* Accesibilidad: reducir movimiento */
    @media (prefers-reduced-motion: reduce){
      .view.active{animation:none}
      .spinner{animation:none; -webkit-animation:none}
    }

    /* Desktop extras */
    @media (min-width: 720px){
      .cards{grid-template-columns:repeat(2, 1fr);}
      .assign-row{grid-template-columns:140px 1fr 1fr;}
    }

    /* Extras locales */
    .hint{margin-top:8px; color:#6b7280; font-size:.9rem;}
    .feedback{background:var(--card); border-radius:14px; box-shadow:var(--shadow); padding:12px; margin-top:12px;}
    .feedback h4{margin:0 0 6px 0;}
    .nums{display:flex; gap:8px; flex-wrap:wrap;}
    .nums .pill{background:#eef2ff; color:#1e3a8a; border-radius:999px; padding:6px 10px; font-weight:700;}
    .edit-panel{background:var(--card); border-radius:12px; box-shadow:var(--shadow); padding:10px; margin-top:10px;}
    .edit-panel .sel{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .edit-panel .tag{border-radius:999px; padding:6px 10px; font-weight:700; background:#e5e7eb; color:#374151;}
    .edit-panel .tag.src{background:#fef3c7; color:#92400e;}
    .edit-panel .tag.dst{background:#dbeafe; color:#1e40af;}
    .hidden{display:none !important;}
    .seat.mine{outline:3px solid #6366f1;}
  </style>
</head>
<body>
  <!-- Cabecera con logo (desde backend), dentro de chip “glass” y centrado -->
  <header class="hero" aria-label="Cabecera">
    <div class="brand-chip">
      <img id="heroLogo" src="" alt="Logo de la empresa"/>
    </div>
  </header>

  <main id="app" class="app">
    <!-- ===== Inicio ===== -->
    <section id="view-home" class="view active" aria-label="Inicio">
      <div class="home-center">
        <div class="cards">
          <article class="card" tabindex="0" role="button" onclick="goSelect()" onkeypress="handleEnter(event, goSelect)">
            <h2>Seleccionar asiento</h2>
            <p>Elige tu lugar en el bus y confirma con tu nombre y CI.</p>
          </article>
          <article class="card" tabindex="0" role="button" onclick="goFind()" onkeypress="handleEnter(event, goFind)">
            <h2>Buscar por CI</h2>
            <p>Ingresa tu CI para ver tus números de asiento y el croquis.</p>
          </article>
          <article class="card" tabindex="0" role="button" onclick="goControl()" onkeypress="handleEnter(event, goControl)">
            <h2>Control interno</h2>
            <p>Ocupación por número, exportar PDF y edición de asientos.</p>
          </article>
        </div>
      </div>
    </section>

    <!-- ===== Selección ===== -->
    <section id="view-select" class="view" aria-label="Seleccionar asiento">
      <form id="selectForm" class="form" onsubmit="event.preventDefault(); startSelection();">
        <div class="form-row">
          <label for="nombrePrincipal">Nombre del pasajero</label>
          <input id="nombrePrincipal" type="text" placeholder="Nombre y Apellido" required/>
        </div>
        <div class="form-row">
          <label for="ciPrincipal">CI del pasajero</label>
          <input id="ciPrincipal" type="text" placeholder="Ej.: 12345678" inputmode="numeric" required/>
        </div>
        <div class="actions">
          <button type="submit" class="btn primary">Reservar</button>
          <!-- Con animación -->
          <button type="button" class="btn ghost" onclick="refreshSeatsWithSpinner('grid-select')">Actualizar</button>
        </div>
        <p class="hint">Presiona “Actualizar” para ver reservas recientes.</p>
      </form>

      <div id="legend" class="legend">
        <span class="badge libre">Libre</span>
        <span class="badge ocupado">Ocupado</span>
        <span class="badge seleccionado">Seleccionado</span>
        <span class="badge inexistente">Gris: Inhabilitado / No disponible</span>
      </div>

      <div id="grid-select" class="grid" aria-live="polite" aria-busy="true"></div>

      <section id="view-assign" class="assign hidden" aria-label="Asignar nombres">
        <h3>Asignar nombres a tus asientos</h3>
        <p>Como reservaste más de un asiento, indicanos los nombres y CI de tu dupla o grupo.</p>
        <div id="assignList" class="assign-list"></div>
        <div class="actions">
          <button type="button" class="btn ghost" onclick="backToSelect()">Volver (cambiar asientos)</button>
          <button type="button" class="btn success" onclick="confirmReservation()">Confirmar reserva</button>
        </div>
      </section>

      <!-- Reserva confirmada con detalle -->
      <div id="reserveFeedback" class="feedback hidden">
        <h4>Reserva confirmada</h4>
        <div id="reserveNums" class="nums"></div>
        <div class="actions" style="margin-top:8px;">
          <button type="button" class="btn ghost" onclick="goHome()">Inicio</button>
        </div>
      </div>
    </section>

    <!-- ===== Buscar por CI ===== -->
    <section id="view-find" class="view" aria-label="Ver mi asiento">
      <form id="findForm" class="form" onsubmit="event.preventDefault(); findByCI();">
        <div class="form-row">
          <label for="ciSearch">CI del pasajero</label>
          <input id="ciSearch" type="text" placeholder="Ej.: 12345678" inputmode="numeric" required/>
        </div>
        <div class="actions">
          <button type="submit" class="btn primary">Buscar</button>
          <button type="button" class="btn ghost" onclick="goHome()">Inicio</button>
        </div>
      </form>

      <div id="findFeedback" class="feedback hidden">
        <h4>Asientos para tu CI</h4>
        <div id="findNums" class="nums"></div>
        <div class="actions" style="margin-top:8px;">
          <button id="btnShowCroquis" type="button" class="btn primary" onclick="showCroquisForCI()">Ver croquis</button>
        </div>
      </div>

      <div id="grid-find" class="grid" aria-live="polite" aria-busy="true"></div>
    </section>

    <!-- ===== Control interno ===== -->
    <section id="view-control" class="view" aria-label="Control interno">
      <form id="controlForm" class="form" onsubmit="event.preventDefault(); doControlLogin();">
        <div class="form-row">
          <label for="ctlUser">Usuario</label>
          <input id="ctlUser" type="text" placeholder="Usuario" autocomplete="username" required/>
        </div>
        <div class="form-row">
          <label for="ctlPass">Contraseña</label>
          <input id="ctlPass" type="password" placeholder="Contraseña" autocomplete="current-password" required/>
        </div>
        <div class="actions">
          <button type="submit" class="btn primary">Ingresar</button>
          <button type="button" class="btn ghost" onclick="goHome()">Inicio</button>
        </div>
        <p class="hint">Acceso exclusivo para el staff.</p>
      </form>

      <div id="controlBoard" class="control-board hidden">
        <h4>Ocupación por número</h4>
        <div class="control-actions">
          <!-- Con animación -->
          <button type="button" class="btn ghost" onclick="refreshSeatsWithSpinner(null, renderControlBoard)">Actualizar</button>
          <button type="button" class="btn primary" onclick="doExportPdf()">Exportar PDF</button>
          <button type="button" class="btn ghost" onclick="doControlLogout()">Cerrar sesión</button>
          <button id="btnEditMode" type="button" class="btn success" onclick="toggleControlEdit()">Modo edición</button>
        </div>

        <!-- Panel de edición -->
        <div id="editPanel" class="edit-panel hidden">
          <div class="sel">
            <span class="tag src" id="tagSrc">Origen: —</span>
            <span class="tag dst" id="tagDst">Destino: —</span>
            <span class="hint">Selecciona un asiento <b>ocupado</b> (origen) y luego uno <b>libre</b> (destino).</span>
          </div>
          <div class="actions" style="margin-top:8px;">
            <button type="button" class="btn primary" onclick="movePassenger()">Mover pasajero</button>
            <button type="button" class="btn danger" onclick="freeSelectedSeat()">Liberar asiento</button>
            <button type="button" class="btn ghost" onclick="cancelEdit()">Cancelar</button>
          </div>
        </div>

        <div id="controlGrid" class="control-grid" aria-live="polite"></div>
        <div id="pdfLinkFallback" class="hint hidden"></div>
      </div>
    </section>
  </main>

  <!-- Overlay de carga -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="loader">
      <div class="spinner"></div>
      <div class="loader-text">Cargando…</div>
    </div>
  </div>

  <!-- Snackbar -->
  <div id="snackbar" class="snackbar" role="status" aria-live="assertive" aria-atomic="true"></div>

  <!-- ===== api.js (embebido) ===== -->
  <script>
    const BASE_URL = 'https://script.google.com/macros/s/AKfycbz6WeyWOfRGGW35sUUyQesTbUoITSNNLCXMhft-saHaHYwDwHWUa6kMT5Cof1GkuFL2/exec';
    const API_KEY = null;

    const QS = (params = {}) =>
      '?' + Object.entries(params)
        .filter(([, v]) => v !== undefined && v !== null && v !== '')
        .map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`)
        .join('&');

    async function parseResponse(res) { const text = await res.text(); try { return JSON.parse(text); } catch { return text; } }
    function withCommonParams(extra = {}) { const base = { api: '1', ...extra }; if (API_KEY) base.apiKey = API_KEY; return base; }
    function getUrl(action, extraParams = {}) { const params = withCommonParams({ action, ...extraParams }); return BASE_URL + QS(params); }
    function postOptions(payloadObj) {
      return { method: 'POST', redirect: 'follow', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payloadObj || {}) };
    }

    async function apiPing()        { const res = await fetch(getUrl('ping'));        if (!res.ok) throw new Error(`GET ping: ${res.status}`);        return parseResponse(res); }
    async function apiGetSeats()    { const res = await fetch(getUrl('seats'));       if (!res.ok) throw new Error(`GET seats: ${res.status}`);       return parseResponse(res); }
    async function apiGetSeatsByCi(ci) { const res = await fetch(getUrl('seatsByCi', { ci })); if (!res.ok) throw new Error(`GET seatsByCi: ${res.status}`); return parseResponse(res); }
    async function apiGetLogo()     { const res = await fetch(getUrl('logo'));        if (!res.ok) throw new Error(`GET logo: ${res.status}`);        return parseResponse(res); }
    async function apiExportPdf()   { const res = await fetch(getUrl('exportPdf'));   if (!res.ok) throw new Error(`GET exportPdf: ${res.status}`);   return parseResponse(res); }

    async function apiReserve(pairs)               { const res = await fetch(getUrl('reserve'), postOptions({ pairs }));                  if (!res.ok) throw new Error(`POST reserve: ${res.status}`); return parseResponse(res); }
    async function apiMove(sourceCode,targetCode)  { const res = await fetch(getUrl('move'),    postOptions({ sourceCode, targetCode })); if (!res.ok) throw new Error(`POST move: ${res.status}`);    return parseResponse(res); }
    async function apiFree(code)                   { const res = await fetch(getUrl('free'),    postOptions({ code }));                    if (!res.ok) throw new Error(`POST free: ${res.status}`);    return parseResponse(res); }
    async function apiLogin(user,pass)             { const res = await fetch(getUrl('login'),   postOptions({ user, pass }));              if (!res.ok) throw new Error(`POST login: ${res.status}`);   return parseResponse(res); }

    window.API = { apiPing, apiGetSeats, apiGetSeatsByCi, apiGetLogo, apiExportPdf, apiReserve, apiMove, apiFree, apiLogin };
  </script>

  <!-- ===== Lógica de la app ===== -->
  <script>
    function showView(id){ document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function goHome(){ showView('view-home'); }
    function goSelect(){ showView('view-select'); refreshSeats('grid-select'); }
    function goFind(){ showView('view-find'); clearFindView(); }
    function goControl(){ showView('view-control'); hideControlBoard(); }
    function handleEnter(ev, cb){ if(ev.key === 'Enter') cb(); }

    let SEATS = {}; let selected = new Set(); let NUM_LABELS = new Map();
    let HIGHLIGHT_CODES = new Set(); let LAST_FOUND_CODES = []; let CONTROL_AUTH = false;
    let CONTROL_EDIT = false; let EDIT_SRC = null; let EDIT_DST = null;

    function toast(msg){ const bar = document.getElementById('snackbar'); bar.textContent = msg; bar.classList.add('show'); setTimeout(() => bar.classList.remove('show'), 2800); }
    function showLoading(msg){ const ov = document.getElementById('overlay'); ov.querySelector('.loader-text').textContent = msg || 'Cargando…'; ov.setAttribute('aria-hidden','false'); ov.classList.add('show'); }
    function hideLoading(){ const ov = document.getElementById('overlay'); ov.classList.remove('show'); ov.setAttribute('aria-hidden','true'); }

    function normalize(code){ return (code||'').toString().replace(/\u00A0/g,' ').replace(/\s+/g,'').trim().toUpperCase(); }

    async function refreshSeats(targetId, onDone){
      const gridEl = targetId ? document.getElementById(targetId) : null;
      if(gridEl) gridEl.setAttribute('aria-busy','true');
      try{
        const resp = await API.apiGetSeats();
        const rows = resp.rows || [];
        SEATS = {};
        rows.forEach(r => { SEATS[ normalize(r.asiento) ] = { estado: r.estado, pasajero: r.pasajero || '', ci: r.ci || '' }; });
        if(gridEl){ buildGrid(targetId); }
      }catch(err){
        toast('Error al cargar asientos');
        if(gridEl){ buildGrid(targetId); }
      }finally{
        if (typeof onDone === 'function') try { onDone(); } catch(e){}
      }
    }
    function refreshSeatsWithSpinner(targetId, onDone){ showLoading('Actualizando asientos…'); refreshSeats(targetId, () => { hideLoading(); if (typeof onDone === 'function') onDone(); }); }

    function getMaxRow(){
      let maxRow = 0;
      Object.keys(SEATS).forEach(code => { const m = code.match(/^(\d+)[A-Z]$/); if(m){ const row = parseInt(m[1],10); if(row > maxRow) maxRow = row; } });
      return maxRow || 0;
    }
    function computeClassFor(code){
      const key = normalize(code);
      if(!SEATS.hasOwnProperty(key)) return 'inexistente';
      const st = (SEATS[key].estado || '').toLowerCase().trim();
      if(st === 'ocupado') return 'ocupado';
      if(st === 'inhabilitado') return 'inexistente';
      return 'libre';
    }

    function buildGrid(targetId){
      const grid = document.getElementById(targetId || 'grid-select'); if(!grid) return;
      grid.innerHTML = ''; grid.removeAttribute('aria-busy'); selected = new Set(); NUM_LABELS = new Map();

      const maxRow = getMaxRow(); if(maxRow === 0){ grid.innerHTML = '<p class="empty">No hay asientos cargados en la hoja.</p>'; return; }

      let seatNumber = 1;
      for(let row=1; row<=maxRow; row++){
        const labelsLeft  = ['A','B']; const labelsRight = ['C','D'];
        const rowEl = document.createElement('div'); rowEl.className = 'row';
        const left  = document.createElement('div'); left.className  = 'block';
        const right = document.createElement('div'); right.className = 'block';

        for(const letter of labelsLeft){
          const code  = `${row}${letter}`;
          const klass = computeClassFor(code);
          const btn   = document.createElement('button'); btn.type='button'; btn.className = `seat ${klass}`;
          const isNum = (klass === 'libre' || klass === 'ocupado');
          const norm = normalize(code);
          if(isNum){
            btn.textContent = seatNumber; btn.setAttribute('data-code', code);
            btn.setAttribute('aria-label', `Asiento ${code} (${seatNumber}) ${klass}`);
            NUM_LABELS.set(norm, seatNumber); seatNumber++;
          }else{
            btn.innerHTML = '&nbsp;'; btn.setAttribute('aria-label', `Asiento ${code} inhabilitado/no disponible`);
          }
          if(klass === 'libre'){ btn.onclick = () => toggleSeat(code, btn); } else { btn.disabled = true; }
          if(HIGHLIGHT_CODES.has(norm)) btn.classList.add('mine');
          left.appendChild(btn);
        }

        const aisle = document.createElement('div'); aisle.className = 'aisle';

        for(const letter of labelsRight){
          const code  = `${row}${letter}`;
          const klass = computeClassFor(code);
          const btn   = document.createElement('button'); btn.type='button'; btn.className = `seat ${klass}`;
          const isNum = (klass === 'libre' || klass === 'ocupado');
          const norm = normalize(code);
          if(isNum){
            btn.textContent = seatNumber; btn.setAttribute('data-code', code);
            btn.setAttribute('aria-label', `Asiento ${code} (${seatNumber}) ${klass}`);
            NUM_LABELS.set(norm, seatNumber); seatNumber++;
          }else{
            btn.innerHTML = '&nbsp;'; btn.setAttribute('aria-label', `Asiento ${code} inhabilitado/no disponible`);
          }
          if(klass === 'libre'){ btn.onclick = () => toggleSeat(code, btn); } else { btn.disabled = true; }
          if(HIGHLIGHT_CODES.has(norm)) btn.classList.add('mine');
          right.appendChild(btn);
        }

        rowEl.appendChild(left); rowEl.appendChild(aisle); rowEl.appendChild(right);
        grid.appendChild(rowEl);
      }

      if(HIGHLIGHT_CODES.size){
        const first = grid.querySelector('.seat.mine');
        if(first) first.scrollIntoView({behavior:'smooth', block:'center'});
      }
    }

    function toggleSeat(code, el){
      const key = normalize(code);
      const isSel = selected.has(key);
      if(isSel){ selected.delete(key); el.classList.remove('seleccionado'); }
      else { selected.add(key); el.classList.add('seleccionado'); }
      updateAssignVisibility();
    }
    function updateAssignVisibility(){ if(selected.size > 1){ document.getElementById('view-assign').classList.remove('hidden'); } else { document.getElementById('view-assign').classList.add('hidden'); } }
    function backToSelect(){ document.getElementById('view-assign').classList.add('hidden'); }

    async function startSelection(){
      if(selected.size === 0){ toast('Elegí al menos un asiento'); return; }
      const nombre = document.getElementById('nombrePrincipal').value.trim();
      const ci     = document.getElementById('ciPrincipal').value.trim();
      if(!nombre || !ci){ toast('Completá nombre y CI'); return; }

      if(selected.size === 1){
        const only = Array.from(selected)[0];
        const onlyNorm = normalize(only);
        const pairs = [{ asiento: onlyNorm, pasajero: nombre, ci }];
        showLoading('Reservando…');
        try{
          const resp = await API.apiReserve(pairs);
          hideLoading();
          showReserveFeedbackDetailed(pairs);
          refreshSeats('grid-select');
        }catch(err){
          hideLoading(); toast('No se pudo reservar');
        }
        return;
      }

      const assign = document.getElementById('assignList');
      assign.innerHTML = '';
      const codes = Array.from(selected);
      for(let i=0;i<codes.length;i++){
        const codeNorm = normalize(codes[i]);
        const num = NUM_LABELS.get(codeNorm) || '';
        const row = document.createElement('div');
        row.className = 'assign-row';
        row.setAttribute('data-code', codeNorm);
        const title = document.createElement('div'); title.className = 'assign-title'; title.textContent = `Asiento ${num || codeNorm}`;
        const name = document.createElement('input'); name.type='text'; name.placeholder='Nombre'; name.required=true; name.value = i===0 ? nombre : '';
        const ciInput = document.createElement('input'); ciInput.type='text'; ciInput.placeholder='CI'; ciInput.required=true; ciInput.value = i===0 ? ci : '';
        row.appendChild(title); row.appendChild(name); row.appendChild(ciInput);
        assign.appendChild(row);
      }
      document.getElementById('view-assign').classList.remove('hidden');
      document.getElementById('view-assign').scrollIntoView({behavior:'smooth'});
    }

    async function confirmReservation(){
      const inputs = document.querySelectorAll('#assignList .assign-row');
      const pairs = [];
      for(let i=0;i<inputs.length;i++){
        const row = inputs[i];
        const codeNorm = row.getAttribute('data-code');
        const asiento  = codeNorm;
        const pasajero = row.querySelector('input[type="text"]').value.trim();
        const ci       = row.querySelectorAll('input')[1].value.trim();
        if(!pasajero || !ci){ toast(`Faltan datos en ${asiento}`); return; }
        pairs.push({ asiento, pasajero, ci });
      }
      showLoading('Reservando…');
      try{
        const resp = await API.apiReserve(pairs);
        showReserveFeedbackDetailed(pairs);
        refreshSeats('grid-select');
        document.getElementById('view-assign').classList.add('hidden');
      }catch(err){
        toast('No se pudo reservar');
      }finally{ hideLoading(); }
    }

    function showReserveFeedbackDetailed(pairs){
      const panel = document.getElementById('reserveFeedback');
      const nums  = document.getElementById('reserveNums');
      nums.innerHTML = '';
      (pairs || []).forEach(p => {
        const norm = normalize(p.asiento);
        const num  = NUM_LABELS.get(norm);
        const pill = document.createElement('span'); pill.className = 'pill';
        const labelNum = (typeof num !== 'undefined') ? num : norm;
        pill.textContent = `${labelNum} — ${p.pasajero} (${p.ci})`;
        nums.appendChild(pill);
      });
      panel.classList.remove('hidden');
      panel.scrollIntoView({behavior:'smooth'});
    }

    async function findByCI(){
      const ci = document.getElementById('ciSearch').value.trim();
      if(!ci){ toast('Ingresá tu CI'); return; }
      showLoading('Buscando…');
      try{
        const respSeats = await API.apiGetSeatsByCi(ci);
        LAST_FOUND_CODES = (respSeats.seats || []).map(s => normalize(s));
        const respRows = await API.apiGetSeats();
        const rows = respRows.rows || [];
        SEATS = {}; rows.forEach(r => { SEATS[ normalize(r.asiento) ] = { estado: r.estado, pasajero: r.pasajero || '', ci: r.ci || '' }; });
        const nums = computeNumbersForCodes(LAST_FOUND_CODES);
        renderFindFeedback(nums);
      }catch(err){
        toast('Error al buscar por CI');
      }finally{ hideLoading(); }
    }

    function computeNumbersForCodes(codes){
      NUM_LABELS = new Map();
      const maxRow = getMaxRow();
      let seatNumber = 1;
      const isNum = (klass) => (klass === 'libre' || klass === 'ocupado');
      for(let row=1; row<=maxRow; row++){
        const labelsLeft  = ['A','B']; const labelsRight = ['C','D'];
        for(const letter of labelsLeft.concat(labelsRight)){
          const code = `${row}${letter}`; const klass = computeClassFor(code); const norm = normalize(code);
          if(isNum(klass)){ NUM_LABELS.set(norm, seatNumber); seatNumber++; }
        }
      }
      return codes.map(c => NUM_LABELS.get(c)).filter(n => typeof n !== 'undefined');
    }

    function renderFindFeedback(nums){
      const panel = document.getElementById('findFeedback');
      const list  = document.getElementById('findNums');
      const btn   = document.getElementById('btnShowCroquis');
      list.innerHTML = '';
      if(nums.length){
        nums.forEach(n => { const pill = document.createElement('span'); pill.className='pill'; pill.textContent=n; list.appendChild(pill); });
        panel.classList.remove('hidden'); btn.disabled = false; panel.scrollIntoView({behavior:'smooth'});
      }else{
        panel.classList.remove('hidden'); list.innerHTML = '<span class="pill">Sin asientos</span>'; btn.disabled = true;
      }
    }

    function showCroquisForCI(){
      HIGHLIGHT_CODES = new Set(LAST_FOUND_CODES);
      showLoading('Cargando croquis…');
      refreshSeats('grid-find', () => {
        hideLoading();
        document.getElementById('grid-find').scrollIntoView({behavior:'smooth'});
      });
    }

    function clearFindView(){
      document.getElementById('findFeedback').classList.add('hidden');
      document.getElementById('findNums').innerHTML = '';
      document.getElementById('grid-find').innerHTML = '';
      HIGHLIGHT_CODES = new Set(); LAST_FOUND_CODES = [];
    }

    async function doControlLogin(){
      const u = document.getElementById('ctlUser').value.trim();
      const p = document.getElementById('ctlPass').value.trim();
      showLoading('Verificando…');
      try{
        const resp = await API.apiLogin(u,p);
        if(resp && resp.ok){
          CONTROL_AUTH = true;
          showLoading('Cargando ocupación…');
          await refreshSeats(null, renderControlBoard);
        }else{
          CONTROL_AUTH = false; toast('Usuario o contraseña inválidos');
        }
      }catch(err){
        toast('Error de verificación');
      }finally{ hideLoading(); }
    }
    function doControlLogout(){ CONTROL_AUTH = false; hideControlBoard(); document.getElementById('ctlPass').value = ''; toast('Sesión finalizada'); }

    function renderControlBoard(){
      if(!CONTROL_AUTH){ hideControlBoard(); return; }
      const board = document.getElementById('controlBoard');
      const grid  = document.getElementById('controlGrid');
      const fb    = document.getElementById('pdfLinkFallback');
      board.classList.remove('hidden'); grid.innerHTML = ''; fb.classList.add('hidden'); fb.innerHTML = '';

      const maxRow = getMaxRow(); let seatNumber = 1;
      for(let row=1; row<=maxRow; row++){
        const labels = ['A','B','C','D'];
        for(const letter of labels){
          const code = `${row}${letter}`; const norm = normalize(code);
          const klass = computeClassFor(code); const isNum = (klass === 'libre' || klass === 'ocupado');
          if(!isNum) continue;
          const data = SEATS[norm] || {}; const estado = (data.estado || '').toLowerCase().trim();
          const item = document.createElement('div');
          item.className = `item ${estado === 'ocupado' ? 'occupied' : 'free'}`;
          item.setAttribute('data-num', seatNumber);
          item.setAttribute('data-code', code);
          item.setAttribute('data-status', estado || 'libre');
          const num = document.createElement('div'); num.className = 'num'; num.textContent = seatNumber;
          const lab = document.createElement('div'); lab.className = 'label'; lab.textContent = (estado === 'ocupado') ? (data.pasajero || 'Ocupado') : 'Libre';
          item.appendChild(num); item.appendChild(lab);
          item.onclick = () => onControlItemClick(item);
          grid.appendChild(item);
          seatNumber++;
        }
      }
      board.scrollIntoView({behavior:'smooth'});
    }
    function hideControlBoard(){
      document.getElementById('controlBoard').classList.add('hidden');
      document.getElementById('controlGrid').innerHTML = '';
      const fb = document.getElementById('pdfLinkFallback'); fb.classList.add('hidden'); fb.innerHTML = '';
      CONTROL_EDIT = false; EDIT_SRC = null; EDIT_DST = null;
      document.getElementById('editPanel').classList.add('hidden');
      document.getElementById('btnEditMode').classList.remove('danger');
      document.getElementById('btnEditMode').textContent = 'Modo edición';
    }

    function toggleControlEdit(){
      CONTROL_EDIT = !CONTROL_EDIT;
      const panel = document.getElementById('editPanel');
      const btn   = document.getElementById('btnEditMode');
      if(CONTROL_EDIT){
        panel.classList.remove('hidden');
        btn.classList.add('danger'); btn.textContent = 'Salir de edición';
        EDIT_SRC = null; EDIT_DST = null; updateEditTags(); toast('Modo edición activo: elige origen (ocupado) y destino (libre).');
      }else{
        panel.classList.add('hidden');
        btn.classList.remove('danger'); btn.textContent = 'Modo edición';
        clearEditSelections();
      }
    }
    function onControlItemClick(item){
      if(!CONTROL_EDIT) return;
      const status = (item.getAttribute('data-status') || 'libre').toLowerCase().trim();
      const num = parseInt(item.getAttribute('data-num'),10);
      const code = item.getAttribute('data-code');
      if(status === 'ocupado'){
        if(EDIT_SRC && EDIT_SRC.num === num){ EDIT_SRC = null; item.classList.remove('pick-source'); }
        else{ document.querySelectorAll('.item.pick-source').forEach(el => el.classList.remove('pick-source')); EDIT_SRC = { num, code }; item.classList.add('pick-source'); }
      }else if(status === 'libre'){
        if(EDIT_DST && EDIT_DST.num === num){ EDIT_DST = null; item.classList.remove('pick-target'); }
        else{ document.querySelectorAll('.item.pick-target').forEach(el => el.classList.remove('pick-target')); EDIT_DST = { num, code }; item.classList.add('pick-target'); }
      }
      updateEditTags();
    }
    function updateEditTags(){
      const tagSrc = document.getElementById('tagSrc'), tagDst = document.getElementById('tagDst');
      tagSrc.textContent = `Origen: ${EDIT_SRC ? `${EDIT_SRC.num} • ${EDIT_SRC.code}` : '—'}`;
      tagDst.textContent = `Destino: ${EDIT_DST ? `${EDIT_DST.num} • ${EDIT_DST.code}` : '—'}`;
    }
    function clearEditSelections(){
      EDIT_SRC = null; EDIT_DST = null;
      document.querySelectorAll('.item.pick-source').forEach(el => el.classList.remove('pick-source'));
      document.querySelectorAll('.item.pick-target').forEach(el => el.classList.remove('pick-target'));
      updateEditTags();
    }
    async function movePassenger(){
      if(!EDIT_SRC || !EDIT_DST){ toast('Selecciona origen (ocupado) y destino (libre).'); return; }
      showLoading('Moviendo pasajero…');
      try{ const resp = await API.apiMove(EDIT_SRC.code, EDIT_DST.code); toast(resp && resp.message ? resp.message : 'Movimiento realizado'); clearEditSelections(); refreshSeats(null, renderControlBoard); }
      catch(err){ toast('No se pudo mover al pasajero'); }
      finally{ hideLoading(); }
    }
    async function freeSelectedSeat(){
      if(!EDIT_SRC){ toast('Selecciona primero un asiento ocupado (origen) para liberar.'); return; }
      showLoading('Liberando asiento…');
      try{ const resp = await API.apiFree(EDIT_SRC.code); toast(resp && resp.message ? resp.message : 'Asiento liberado'); clearEditSelections(); refreshSeats(null, renderControlBoard); }
      catch(err){ toast('No se pudo liberar el asiento'); }
      finally{ hideLoading(); }
    }

    async function doExportPdf(){
      if(!CONTROL_AUTH){ toast('Debes iniciar sesión'); return; }
      showLoading('Generando PDF…');
      try{
        const resp = await API.apiExportPdf();
        if(resp && resp.url){
          const newWin = window.open(resp.url, '_blank');
          if(!newWin){
            const fb = document.getElementById('pdfLinkFallback');
            fb.innerHTML = 'Tu PDF está listo: <a href="'+resp.url+'" target="_blank" rel="noopener">Abrir PDF</a>';
            fb.classList.remove('hidden');
          }else{ toast('PDF listo'); }
        }else{ toast(resp && resp.message ? resp.message : 'No se pudo generar el PDF'); }
      }catch(err){ toast('Error al generar PDF'); }
      finally{ hideLoading(); }
    }

    (async function init(){
      try{
        const payload = await API.apiGetLogo();
        const img = document.getElementById('heroLogo');
        if(payload && payload.dataUrl){ img.src = payload.dataUrl; }
        else if(payload && payload.publicUrl){ img.src = payload.publicUrl; }
      }catch(e){ /* noop */ }
      refreshSeats('grid-select');
    })();
  </script>
</body>
</html>
